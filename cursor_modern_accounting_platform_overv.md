# Modern accounting platform overview
_Exported on 12/28/2025 at 11:34:39 PST from Cursor (2.2.43)_

---

**User**

I am building a modern accounting and tax operations platform that centralizes client document collection, communication, internal workflow, and filing readiness. The system uses Supabase as the system of record for data, authentication, storage, and access control; Next.js for the staff/admin and client web experience; React Native (Expo) for the client mobile app; and n8n for event-driven automation, notifications, and reminders. The platform is designed to be audit-safe, non-blocking for clients, and to accurately reflect real-world accounting workflows.   I have all mapped out in pdf documents - I will upload for your review ! only review now no action please - let's talk through it first.  - 

---

**Cursor**


Reviewing the workspace and waiting for the PDFs. Exploring the current project structure.



Reviewing a few more files to understand the current state:



Current state:
- **Admin**: Vue.js + Vite (not Next.js)
- **Client**: Flutter (not React Native/Expo)
- **Backend**: Supabase (mentioned in docs, not yet integrated)

Your plan:
- **Admin/Staff/Client Web**: Next.js
- **Client Mobile**: React Native (Expo)
- **Backend**: Supabase
- **Automation**: n8n

I’m ready to review your PDFs. After reviewing, I’ll:
1. Identify gaps between the current codebase and your plan
2. Outline the migration/rebuild needed
3. Propose an implementation plan aligned with your architecture

Please upload the PDFs when ready. I’ll review them and discuss the approach before any changes.

---

**User**

trying to upload but it's not working somehow...ideas why?

---

**Cursor**


I can’t receive direct file uploads in chat. Here are ways to share the PDF content:

**Option 1: Place PDFs in the workspace**
- Copy the PDFs into your project folder (e.g., `C:\Projects\fineform-app\docs\`)
- I can try to read them, though PDFs may need to be converted to text first

**Option 2: Copy/paste key sections**
- Copy the text from the PDFs and paste it here
- Focus on architecture, data models, workflows, and requirements

**Option 3: Describe the structure**
- Summarize the main sections and I’ll ask targeted questions

**Option 4: Convert to markdown/text**
- Convert the PDFs to `.md` or `.txt` and place them in the workspace

Which option works best? If you prefer, I can create a `docs/` folder and you can add the files there, or you can paste the key content directly.

What’s the main focus of the PDFs—architecture diagrams, database schema, user flows, feature requirements, or all of the above?

---

**User**

i placed .md files in the docs folder

---

**Cursor**


Reviewing the markdown files in the docs folder.



Reading all documentation files to understand the system:



Reviewing the documentation. Summarizing findings and questions:



Summary:
- Architecture: Supabase backend, Next.js admin/staff/client web, React Native (Expo) client mobile, n8n automation
- Current state: Vue.js admin, Flutter client, no Supabase integration
- System principles: Deterministic, backend as source of truth, non-blocking for clients, audit-safe
- 8 workflows covering the tax season lifecycle
- Build phases: Backend → Admin → Client → Hardening

Clarifying questions:



Creating the implementation plan:


---

**User**

no need to archive existing vue.js just delete

---

**Cursor**


Updating the plan to delete the existing Vue.js admin code instead of archiving it.



Updating the plan to delete the Vue.js admin code instead of archiving it.


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/, legacy/ directories"
    status: pending
  - id: phase0-delete-vue-admin
    content: Delete existing Vue.js admin code (admin/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 14+ admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**
- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**
- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure
Create new directory structure:
```
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
├── docs/                   # Existing documentation (keep)
└── legacy/                 # Archive existing Vue/Flutter code
    ├── admin-vue/
    └── client-flutter/
```

### 0.2 Archive Existing Code
- Move `admin/` → `legacy/admin-vue/`
- Move `client/` → `legacy/client-flutter/`
- Preserve for reference during migration

### 0.3 Initialize Next.js Admin App
- Create `apps/admin/` with Next.js 14+ (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App
- Create `apps/client/` with Expo SDK 50+
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup
- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment
- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**
- `profiles` (mirrors auth.users)
  - `id` (UUID, FK to auth.users)
  - `user_type` (enum: staff | client)
  - `full_name`, `email`, `active`
- `staff_profiles`
  - `user_id` (FK → profiles)
  - `staff_role` (enum: super_admin | admin | staff)
  - `staff_team_reporting` (fine_form | fin_group - reporting only)
  - `job_title`, `active`

**RLS Policies:**
- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**
- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**
- `accounts` (households/organizations)
  - `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
  - `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
  - `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**
- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)

**Core Identity:**
- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**
- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**
- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**
- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**
- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**
- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**
- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**
- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**
- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**
- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**
- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**
- `client_acl` (restricted client access)
  - `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
  - `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
  - `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**
- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
  - super_admin → always allowed
  - admin → allowed by default
  - staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**
- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**
- `folders`
  - `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
  - Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
  - `folder_id`, `staff_user_id`
- `documents`
  - `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
  - `uploaded_by`, `created_at`, `updated_at`

**Storage:**
- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**
- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**
- `checklist_items`
  - `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
  - `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
  - `checklist_item_id`, `document_id`
- `questionnaire_sections`
  - `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
  - `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**
- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

Logic:
1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):
- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):
- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**
- `message_threads`
  - `id`, `client_entity_id`, `tax_year`, `created_at`
  - Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
  - `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
  - `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**
- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**
- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**
- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**
- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**
- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**
- `status_audit_log`
  - `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
  - `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
  - `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**
- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria
- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup
- Initialize Next.js 14+ in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing
- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control
**Pages/Components:**
- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**
- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)
**Pages/Components:**
- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**
- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard
**Pages/Components:**
- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**
- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management
**Pages/Components:**
- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**
- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review
**Pages/Components:**
- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**
- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations
**Pages/Components:**
- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**
- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)
**Pages/Components:**
- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**
- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria
- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup
- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection
**Screens:**
- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing
**Screens:**
- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**
- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)
**Screens:**
- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**
- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**
- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire
**Screens:**
- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**
- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation
**Screens:**
- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**
- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization
**Screens:**
- Prompt after draft upload
- Signature capture

**API Integration:**
- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads
**Screens:**
- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)
**Screens:**
- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**
- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)
**Screens:**
- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**
- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria
- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing
- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization
- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit
- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation
- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices
- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints
1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy
- Archive existing Vue/Flutter code to `legacy/`
- Build new apps from scratch following blueprint
- Reference legacy code only for UI/UX patterns if needed

### Environment Variables
```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure

This plan follows the authoritative build phases and system blueprint exactly. All logic lives in the backend, workflows are deterministic, and the system is audit-safe.
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/, legacy/ directories"
    status: pending
  - id: phase0-delete-vue-admin
    content: Delete existing Vue.js admin code (admin/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 14+ admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**
- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**
- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure
Create new directory structure:
```
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Archive Existing Code
- Move `admin/` → `legacy/admin-vue/`
- Move `client/` → `legacy/client-flutter/`
- Preserve for reference during migration

### 0.3 Initialize Next.js Admin App
- Create `apps/admin/` with Next.js 14+ (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App
- Create `apps/client/` with Expo SDK 50+
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup
- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment
- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**
- `profiles` (mirrors auth.users)
  - `id` (UUID, FK to auth.users)
  - `user_type` (enum: staff | client)
  - `full_name`, `email`, `active`
- `staff_profiles`
  - `user_id` (FK → profiles)
  - `staff_role` (enum: super_admin | admin | staff)
  - `staff_team_reporting` (fine_form | fin_group - reporting only)
  - `job_title`, `active`

**RLS Policies:**
- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**
- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**
- `accounts` (households/organizations)
  - `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
  - `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
  - `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**
- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)

**Core Identity:**
- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**
- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**
- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**
- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**
- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**
- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**
- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**
- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**
- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**
- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**
- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**
- `client_acl` (restricted client access)
  - `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
  - `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
  - `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**
- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
  - super_admin → always allowed
  - admin → allowed by default
  - staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**
- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**
- `folders`
  - `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
  - Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
  - `folder_id`, `staff_user_id`
- `documents`
  - `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
  - `uploaded_by`, `created_at`, `updated_at`

**Storage:**
- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**
- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**
- `checklist_items`
  - `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
  - `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
  - `checklist_item_id`, `document_id`
- `questionnaire_sections`
  - `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
  - `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**
- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

Logic:
1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):
- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):
- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**
- `message_threads`
  - `id`, `client_entity_id`, `tax_year`, `created_at`
  - Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
  - `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
  - `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**
- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**
- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**
- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**
- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**
- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**
- `status_audit_log`
  - `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
  - `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
  - `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**
- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria
- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup
- Initialize Next.js 14+ in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing
- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control
**Pages/Components:**
- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**
- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)
**Pages/Components:**
- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**
- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard
**Pages/Components:**
- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**
- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management
**Pages/Components:**
- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**
- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review
**Pages/Components:**
- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**
- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations
**Pages/Components:**
- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**
- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)
**Pages/Components:**
- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**
- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria
- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup
- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection
**Screens:**
- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing
**Screens:**
- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**
- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)
**Screens:**
- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**
- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**
- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire
**Screens:**
- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**
- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation
**Screens:**
- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**
- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization
**Screens:**
- Prompt after draft upload
- Signature capture

**API Integration:**
- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads
**Screens:**
- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)
**Screens:**
- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**
- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)
**Screens:**
- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**
- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria
- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing
- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization
- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit
- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation
- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices
- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints
1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy
- Archive existing Vue/Flutter code to `legacy/`
- Build new apps from scratch following blueprint
- Reference legacy code only for UI/UX patterns if needed

### Environment Variables
```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure

This plan follows the authoritative build phases and system blueprint exactly. All logic lives in the backend, workflows are deterministic, and the system is audit-safe.
```

```markdown
### 0.2 Delete Existing Vue.js Admin Code
- Delete `admin/` directory entirely
- Flutter client code in `client/` will be replaced by React Native app in `apps/client/`
```

```markdown
### Migration Strategy
- Delete existing Vue.js admin code
- Flutter client code will be replaced by React Native app
- Build new apps from scratch following blueprint
```


Reading the file to check the exact formatting:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/, legacy/ directories"
    status: pending
  - id: phase0-delete-vue-admin
    content: Delete existing Vue.js admin code (admin/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 14+ admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Vue.js Admin Code

- Delete `admin/` directory entirely
- Flutter client code in `client/` will be replaced by React Native app in `apps/client/`

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 14+ (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo SDK 50+
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
  - `id` (UUID, FK to auth.users)
  - `user_type` (enum: staff | client)
  - `full_name`, `email`, `active`
- `staff_profiles`
  - `user_id` (FK → profiles)
  - `staff_role` (enum: super_admin | admin | staff)
  - `staff_team_reporting` (fine_form | fin_group - reporting only)
  - `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
  - `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
  - `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
  - `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)

**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
  - `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
  - `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
  - `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
  - super_admin → always allowed
  - admin → allowed by default
  - staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
  - `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
  - Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
  - `folder_id`, `staff_user_id`
- `documents`
  - `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
  - `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
  - `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
  - `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
  - `checklist_item_id`, `document_id`
- `questionnaire_sections`
  - `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
  - `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

Logic:

1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
  - `id`, `client_entity_id`, `tax_year`, `created_at`
  - Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
  - `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
  - `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
  - `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
  - `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
  - `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 14+ in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Archive existing Vue/Flutter code to `legacy/`
- Build new apps from scratch following blueprint
- Reference legacy code only for UI/UX patterns if needed

### Environment Variables

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure

This plan follows the authoritative build phases and system blueprint exactly. All logic lives in the backend, workflows are deterministic, and the system is audit-safe.
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/, legacy/ directories"
    status: pending
  - id: phase0-delete-vue-admin
    content: Delete existing Vue.js admin code (admin/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 14+ admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Vue.js Admin Code

- Delete `admin/` directory entirely
- Flutter client code in `client/` will be replaced by React Native app in `apps/client/`

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 14+ (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo SDK 50+
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
  - `id` (UUID, FK to auth.users)
  - `user_type` (enum: staff | client)
  - `full_name`, `email`, `active`
- `staff_profiles`
  - `user_id` (FK → profiles)
  - `staff_role` (enum: super_admin | admin | staff)
  - `staff_team_reporting` (fine_form | fin_group - reporting only)
  - `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
  - `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
  - `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
  - `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)

**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
  - `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
  - `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
  - `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
  - super_admin → always allowed
  - admin → allowed by default
  - staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
  - `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
  - Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
  - `folder_id`, `staff_user_id`
- `documents`
  - `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
  - `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
  - `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
  - `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
  - `checklist_item_id`, `document_id`
- `questionnaire_sections`
  - `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
  - `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

Logic:

1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
  - `id`, `client_entity_id`, `tax_year`, `created_at`
  - Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
  - `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
  - `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
  - `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
  - `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
  - `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 14+ in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code
- Flutter client code will be replaced by React Native app
- Build new apps from scratch following blueprint

### Environment Variables

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure

This plan follows the authoritative build phases and system blueprint exactly. All logic lives in the backend, workflows are deterministic, and the system is audit-safe.
```


Updated the plan to delete the Vue.js admin code instead of archiving it. Changes:

1. **Removed `legacy/` directory** from the monorepo structure
2. **Updated Phase 0.2** to delete the `admin/` directory entirely
3. **Updated the todo item** from "archive" to "delete"
4. **Updated Migration Strategy** to reflect deletion

The plan now:
- Deletes the existing Vue.js admin code (`admin/` directory)
- Notes that the Flutter client in `client/` will be replaced by the React Native app in `apps/client/` (as part of Phase 0 and Phase 3)

The plan is ready. Should I proceed with Phase 0, or do you want any other adjustments?

---

**User**

same with flutter just delete

---

**Cursor**


Updating the plan to delete the Flutter client code as well.


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/, legacy/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 14+ admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Vue.js Admin Code

- Delete `admin/` directory entirely
- Flutter client code in `client/` will be replaced by React Native app in `apps/client/`

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 14+ (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo SDK 50+
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
  - `id` (UUID, FK to auth.users)
  - `user_type` (enum: staff | client)
  - `full_name`, `email`, `active`
- `staff_profiles`
  - `user_id` (FK → profiles)
  - `staff_role` (enum: super_admin | admin | staff)
  - `staff_team_reporting` (fine_form | fin_group - reporting only)
  - `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
  - `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
  - `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
  - `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)

**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
  - `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
  - `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
  - `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
  - super_admin → always allowed
  - admin → allowed by default
  - staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
  - `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
  - Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
  - `folder_id`, `staff_user_id`
- `documents`
  - `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
  - `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
  - `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
  - `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
  - `checklist_item_id`, `document_id`
- `questionnaire_sections`
  - `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
  - `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

Logic:

1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
  - `id`, `client_entity_id`, `tax_year`, `created_at`
  - Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
  - `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
  - `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
  - `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
  - `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
  - `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 14+ in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code
- Flutter client code will be replaced by React Native app
- Build new apps from scratch following blueprint

### Environment Variables

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure

This plan follows the authoritative build phases and system blueprint exactly. All logic lives in the backend, workflows are deterministic, and the system is audit-safe.
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/, legacy/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 14+ admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 14+ (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo SDK 50+
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
  - `id` (UUID, FK to auth.users)
  - `user_type` (enum: staff | client)
  - `full_name`, `email`, `active`
- `staff_profiles`
  - `user_id` (FK → profiles)
  - `staff_role` (enum: super_admin | admin | staff)
  - `staff_team_reporting` (fine_form | fin_group - reporting only)
  - `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
  - `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
  - `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
  - `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)

**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
  - `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
  - `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
  - `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
  - super_admin → always allowed
  - admin → allowed by default
  - staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
  - `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
  - Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
  - `folder_id`, `staff_user_id`
- `documents`
  - `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
  - `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
  - `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
  - `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
  - `checklist_item_id`, `document_id`
- `questionnaire_sections`
  - `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
  - `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

Logic:

1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
  - `id`, `client_entity_id`, `tax_year`, `created_at`
  - Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
  - `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
  - `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
  - `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
  - `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
  - `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 14+ in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code
- Flutter client code will be replaced by React Native app
- Build new apps from scratch following blueprint

### Environment Variables

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure

This plan follows the authoritative build phases and system blueprint exactly. All logic lives in the backend, workflows are deterministic, and the system is audit-safe.
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/, legacy/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 14+ admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 14+ (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo SDK 50+
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
  - `id` (UUID, FK to auth.users)
  - `user_type` (enum: staff | client)
  - `full_name`, `email`, `active`
- `staff_profiles`
  - `user_id` (FK → profiles)
  - `staff_role` (enum: super_admin | admin | staff)
  - `staff_team_reporting` (fine_form | fin_group - reporting only)
  - `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
  - `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
  - `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
  - `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)

**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
  - `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
  - `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
  - `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
  - super_admin → always allowed
  - admin → allowed by default
  - staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
  - `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
  - Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
  - `folder_id`, `staff_user_id`
- `documents`
  - `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
  - `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
  - `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
  - `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
  - `checklist_item_id`, `document_id`
- `questionnaire_sections`
  - `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
  - `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

Logic:

1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
  - `id`, `client_entity_id`, `tax_year`, `created_at`
  - Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
  - `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
  - `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
  - `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
  - `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
  - `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 14+ in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure

This plan follows the authoritative build phases and system blueprint exactly. All logic lives in the backend, workflows are deterministic, and the system is audit-safe.
```


Updating the repo structure todo to remove the legacy directory reference:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 14+ admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 14+ (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo SDK 50+
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
  - `id` (UUID, FK to auth.users)
  - `user_type` (enum: staff | client)
  - `full_name`, `email`, `active`
- `staff_profiles`
  - `user_id` (FK → profiles)
  - `staff_role` (enum: super_admin | admin | staff)
  - `staff_team_reporting` (fine_form | fin_group - reporting only)
  - `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
  - `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
  - `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
  - `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)

**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
  - `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
  - `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
  - `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
  - super_admin → always allowed
  - admin → allowed by default
  - staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
  - `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
  - Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
  - `folder_id`, `staff_user_id`
- `documents`
  - `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
  - `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
  - `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
  - `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
  - `checklist_item_id`, `document_id`
- `questionnaire_sections`
  - `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
  - `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

Logic:

1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
  - `id`, `client_entity_id`, `tax_year`, `created_at`
  - Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
  - `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
  - `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
  - `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
  - `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
  - `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 14+ in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure

This plan follows the authoritative build phases and system blueprint exactly. All logic lives in the backend, workflows are deterministic, and the system is audit-safe.
```


Updated the plan to delete both the Vue.js admin and Flutter client code. Changes:

1. **Updated the todo item** to delete both `admin/` and `client/` directories
2. **Updated Phase 0.2** to delete both directories entirely
3. **Updated Migration Strategy** to reflect deletion of both
4. **Removed legacy/ directory** from the repo structure todo

The plan now deletes both existing codebases and builds the new Next.js admin and React Native client apps from scratch. Ready to proceed when you are.

---

**User**

check what the current cersion of next.js is

---

**Cursor**


Checking the current Next.js version.



Latest stable Next.js: 16.1.1 (released December 22, 2025). Updating the plan to use Next.js 16 instead of 14+.



Updating all references to Next.js 14+ to Next.js 16:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 14+ (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo SDK 50+
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
  - `id` (UUID, FK to auth.users)
  - `user_type` (enum: staff | client)
  - `full_name`, `email`, `active`
- `staff_profiles`
  - `user_id` (FK → profiles)
  - `staff_role` (enum: super_admin | admin | staff)
  - `staff_team_reporting` (fine_form | fin_group - reporting only)
  - `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
  - `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
  - `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
  - `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)

**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
  - `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
  - `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
  - `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
  - super_admin → always allowed
  - admin → allowed by default
  - staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
  - `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
  - Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
  - `folder_id`, `staff_user_id`
- `documents`
  - `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
  - `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
  - `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
  - `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
  - `checklist_item_id`, `document_id`
- `questionnaire_sections`
  - `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
  - `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

Logic:

1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
  - `id`, `client_entity_id`, `tax_year`, `created_at`
  - Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
  - `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
  - `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
  - `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
  - `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
  - `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 14+ in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure

This plan follows the authoritative build phases and system blueprint exactly. All logic lives in the backend, workflows are deterministic, and the system is audit-safe.
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo SDK 50+
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
  - `id` (UUID, FK to auth.users)
  - `user_type` (enum: staff | client)
  - `full_name`, `email`, `active`
- `staff_profiles`
  - `user_id` (FK → profiles)
  - `staff_role` (enum: super_admin | admin | staff)
  - `staff_team_reporting` (fine_form | fin_group - reporting only)
  - `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
  - `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
  - `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
  - `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)

**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
  - `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
  - `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
  - `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
  - super_admin → always allowed
  - admin → allowed by default
  - staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
  - `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
  - Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
  - `folder_id`, `staff_user_id`
- `documents`
  - `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
  - `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
  - `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
  - `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
  - `checklist_item_id`, `document_id`
- `questionnaire_sections`
  - `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
  - `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

Logic:

1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
  - `id`, `client_entity_id`, `tax_year`, `created_at`
  - Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
  - `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
  - `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
  - `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
  - `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
  - `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 14+ in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure

This plan follows the authoritative build phases and system blueprint exactly. All logic lives in the backend, workflows are deterministic, and the system is audit-safe.
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo SDK 50+
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
  - `id` (UUID, FK to auth.users)
  - `user_type` (enum: staff | client)
  - `full_name`, `email`, `active`
- `staff_profiles`
  - `user_id` (FK → profiles)
  - `staff_role` (enum: super_admin | admin | staff)
  - `staff_team_reporting` (fine_form | fin_group - reporting only)
  - `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
  - `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
  - `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
  - `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)

**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
  - `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
  - `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
  - `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
  - super_admin → always allowed
  - admin → allowed by default
  - staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
  - `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
  - Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
  - `folder_id`, `staff_user_id`
- `documents`
  - `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
  - `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
  - `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
  - `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
  - `checklist_item_id`, `document_id`
- `questionnaire_sections`
  - `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
  - `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

Logic:

1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
  - `id`, `client_entity_id`, `tax_year`, `created_at`
  - Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
  - `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
  - `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
  - `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
  - `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
  - `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure

This plan follows the authoritative build phases and system blueprint exactly. All logic lives in the backend, workflows are deterministic, and the system is audit-safe.
```


Updated the plan to use **Next.js 16** (latest stable: 16.1.1) instead of 14+.

**Requirements for Next.js 16:**
- **Node.js**: Version 20.9 or higher
- **TypeScript**: Version 5.1 or higher

The plan now references Next.js 16 throughout. Should I add these requirements to the plan, or proceed as-is?

---

**User**

check waht the most current version of reactnative is

---

**Cursor**


Checking the current React Native version.



Checking the latest Expo SDK version, since we're using Expo:



Found React Native 0.83 (latest stable, released December 10, 2025). Updating the plan to reflect this. Checking the plan for Expo SDK references:



Updating the plan to use React Native 0.83. Updating references:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
  - `id` (UUID, FK to auth.users)
  - `user_type` (enum: staff | client)
  - `full_name`, `email`, `active`
- `staff_profiles`
  - `user_id` (FK → profiles)
  - `staff_role` (enum: super_admin | admin | staff)
  - `staff_team_reporting` (fine_form | fin_group - reporting only)
  - `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
  - `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
  - `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
  - `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)

**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
  - `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
  - `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
  - `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
  - super_admin → always allowed
  - admin → allowed by default
  - staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
  - `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
  - Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
  - `folder_id`, `staff_user_id`
- `documents`
  - `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
  - `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
  - `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
  - `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
  - `checklist_item_id`, `document_id`
- `questionnaire_sections`
  - `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
  - `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

Logic:

1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
  - `id`, `client_entity_id`, `tax_year`, `created_at`
  - Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
  - `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
  - `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
  - `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
  - `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
  - `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure

This plan follows the authoritative build phases and system blueprint exactly. All logic lives in the backend, workflows are deterministic, and the system is audit-safe.
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
  - `id` (UUID, FK to auth.users)
  - `user_type` (enum: staff | client)
  - `full_name`, `email`, `active`
- `staff_profiles`
  - `user_id` (FK → profiles)
  - `staff_role` (enum: super_admin | admin | staff)
  - `staff_team_reporting` (fine_form | fin_group - reporting only)
  - `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
  - `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
  - `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
  - `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)

**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
  - `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
  - `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
  - `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
  - super_admin → always allowed
  - admin → allowed by default
  - staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
  - `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
  - Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
  - `folder_id`, `staff_user_id`
- `documents`
  - `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
  - `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
  - `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
  - `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
  - `checklist_item_id`, `document_id`
- `questionnaire_sections`
  - `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
  - `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
  - `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

Logic:

1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
  - `id`, `client_entity_id`, `tax_year`, `created_at`
  - Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
  - `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
  - `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
  - `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
  - `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
  - `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure

This plan follows the authoritative build phases and system blueprint exactly. All logic lives in the backend, workflows are deterministic, and the system is audit-safe.
```


Updated the plan with the latest React Native version:

**Latest React Native: 0.83** (released December 10, 2025)
- Includes **React 19.2**
- Includes new APIs like `<Activity>` and `useEffectEvent`
- No user-facing breaking changes

The plan now references React Native 0.83. Since we're using Expo, we'll use the latest Expo SDK compatible with React Native 0.83 (Expo typically tracks React Native versions closely).

**Note:** React Native 0.83 includes React 19.2, which may require updates to dependencies and code patterns compared to earlier versions.

The plan is updated. Ready to proceed when you are.

---

**User**

Supabase Info:Project Name	Fine Form App
Project ID	rdhgsrjjlvuyjokpyrbr
Project URL	https://rdhgsrjjlvuyjokpyrbr.supabase.co

---

**Cursor**


Recording the Supabase project details in the plan for Phase 0 and Phase 1 setup.



Updating the plan with the Supabase project information:


```markdown
### 0.5 Supabase Project Setup
- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```



### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**Logic:

1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```



### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**Logic:

1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Get Supabase API keys** - Anon key and Service Role key from Supabase dashboard (Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co)
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**Logic:

1. Engagement fully signed? (`engagement_status = 'fully_signed'`)
2. Checklist complete? (`checklist_complete_at IS NOT NULL`)
3. Document receipt confirmation signed? (`doc_confirmation_status = 'signed'`)
4. Questionnaire submitted? (`questionnaire_status = 'completed'`)
5. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

All true → `ready_for_prep = true`**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```


Updated the plan with your Supabase project information:

**Supabase Project Details:**
- **Project Name**: Fine Form App
- **Project ID**: rdhgsrjjlvuyjokpyrbr
- **Project URL**: https://rdhgsrjjlvuyjokpyrbr.supabase.co

The plan now includes:
1. Project details in Phase 0.5 (Supabase Project Setup)
2. Project URL in the environment variables template
3. Updated Next Steps to note we still need the API keys (Anon key and Service Role key) from the Supabase dashboard

When you're ready to start Phase 0, we'll need:
- **Anon Key** (public, safe for client-side)
- **Service Role Key** (private, server-side only)

The plan is ready. Should I proceed with Phase 0, or do you have the API keys to add now?

---

**User**

i added the various letter and notices to the docs folder for review

---

**Cursor**


Checking the docs folder for the new files:



Reviewing the new letter and notice documents:



Reviewed the four documents. Summary and integration points:

## Documents Reviewed

1. **Engagement Letter** (`engagement_letter_workflow_aligned_authoritative.md`)
   - Template with placeholders: `{{CLIENT_NAME}}`, `{{TAX_YEAR}}`
   - Requires signatures (Taxpayer and Spouse for MFJ)
   - **Integration**: Workflow 2 — Engagement Letter Signatures
   - Needs dynamic generation per `client_entity_id + tax_year`

2. **Documents Confirmation Letter** (`documents_confirmation_letter_workflow_aligned_authoritative.md`)
   - Lists received documents (W-2s, 1099s, Other Documents)
   - Includes N/A items section
   - Requires client acknowledgment
   - **Integration**: Workflow 4 — Document Receipt Confirmation
   - Generated when checklist is complete

3. **Tax Season Start Email** (`tax_season_start_email_workflow_aligned_authoritative.md`)
   - Initial onboarding communication
   - Placeholders: `{{CLIENT_NAME}}`, `{{APP_DOWNLOAD_LINK}}`
   - **Integration**: Workflow 1 — Tax Season Start & Client Invite
   - Sent via n8n when invites are triggered

4. **Privacy Policy** (`privacy_policy_workflow_aligned_authoritative.md`)
   - Standard privacy policy
   - **Integration**: Should be accessible to clients (likely in app settings/legal section)

## Implementation Considerations

These documents will need to be:
- Stored as templates (database or Supabase Storage)
- Dynamically populated with client/entity/tax year data
- Generated at the appropriate workflow stages
- Signed/acknowledged where required (with audit logging)
- Accessible for download/viewing by clients and staff

Should I update the plan to include specific implementation details for these document templates, or do you want to discuss the approach first?

---

**User**

discuss

---

**Cursor**


Discussing implementation details for these document templates. A few questions:


---

**User**

hybrid - let's go throught each one by one - start with tax season start email - this is the first automated email sent to a client when their tax year is opened in the system.
It notifies the client that the Fine Form App is available, provides the app download link, and directs them to log in.
The email explains that the client can immediately access their engagement letter, tax checklist, document uploads, and in-app messaging.
This email is informational only and does not gate access to any features.

---

**Cursor**


Focusing on the Tax Season Start Email. A few questions:



Clarifying a few details:



## Tax Season Start Email - Implementation Plan

**Trigger:**
- Sent automatically when `entity_tax_year.invite_status` is set to `queued`
- Staff controls timing by setting status to `queued`

**Template Storage:**
- Template stored in Supabase database table (e.g., `email_templates` or `document_templates`)
- n8n retrieves template and populates placeholders

**Placeholders:**
- `{{CLIENT_NAME}}` → `client_entities.entity_name`
- `{{TAX_YEAR}}` → Dynamic (defaults to current year, allows override)
- `{{APP_DOWNLOAD_LINK}}` → All links displayed:
  - iOS App Store link
  - Google Play Store link
  - Web App URL

**Delivery:**
- n8n webhook triggered when `invite_status = queued`
- n8n sends email (from address configurable in n8n/system settings)
- Updates `entity_tax_year.invite_status` and `invite_sent_at`
- Logs delivery details in `email_delivery_log` table

**Resend Capability:**
- Automatic retry on failure (with backoff)
- Manual resend button in admin dashboard
- Tracks attempt count in `entity_tax_year.attempt_count`

**Database Schema Needed:**
- `email_templates` table (or `document_templates` for all templates)
- `email_delivery_log` table
- Update `entity_tax_year` with invite tracking fields

Does this match your expectations? Should we move on to the Engagement Letter, or adjust anything for the Tax Season Start Email?

---

**User**

Do not store attempt_count on entity_tax_year. Each send attempt should create a new row in email_delivery_log; attempt count is derived from the log.

---

**Cursor**


Noted. Each email send attempt creates a new row in `email_delivery_log`, and attempt count is derived from the log. This is more audit-safe and aligns with the logging approach.

**Updated Approach:**
- No `attempt_count` field on `entity_tax_year`
- Each send attempt → new row in `email_delivery_log`
- Attempt count = `COUNT(*)` from `email_delivery_log` WHERE `entity_tax_year_id = X` AND `email_type = 'tax_season_start'`
- This provides a full audit trail of all send attempts

**email_delivery_log table structure would include:**
- `id`, `entity_tax_year_id`, `email_type`, `sent_at`, `status` (sent | failed | bounced), `error_message`, `recipient_email`, etc.

This also supports tracking multiple email types (tax season start, reminders, etc.) in one table.

Proceed to the Engagement Letter next, or adjust anything else for the Tax Season Start Email?

---

**User**

his looks correct and matches expectations.
Each send attempt should create a new row in email_delivery_log, with no attempt_count stored on entity_tax_year. Attempt counts are derived via COUNT(*).

Optional refinements:
• include provider_message_id for webhook reconciliation
• distinguish sent vs delivered statuses if supported by the provider

Otherwise, this design is approved. 

---

**Cursor**


Tax Season Start Email design approved with refinements:
- `provider_message_id` for webhook reconciliation
- Separate `sent` vs `delivered` statuses (if provider supports)

Moving to the Engagement Letter. Questions:



Clarifying a few details:


---

**User**

Do not replace the original PDF. Store signatures in engagement_signatures. Generate a new “fully signed” PDF only when all required signatures are complete (e.g., MFJ requires two). Store it as a separate version/path and keep the original for audit.

---

**Cursor**


Noted:
- Original PDF is never replaced (audit requirement)
- Signatures stored in `engagement_signatures` table
- Generate signed PDF only when all required signatures are complete
- Store signed PDF as separate version/path (e.g., `engagement_letter_signed.pdf` vs `engagement_letter.pdf`)
- Original preserved for audit trail

Clarifying the remaining details:


---

**User**

Default to 1 required signature at entity_tax_year creation (assume Single). If filing status is later determined to be MFJ, update required signatures to 2. Engagement status should transition to partially_signed if one signature exists, and fully_signed only when both required signatures are complete. Do not invalidate existing signatures when filing status changes.

---

**Cursor**


## Engagement Letter - Implementation Plan

**Generation:**
- Generated automatically when `entity_tax_year` is created
- n8n generates PDF from template stored in Supabase database
- Original PDF stored in Tax Documents system folder
- Path stored in `entity_tax_year` metadata (e.g., `engagement_letter_path`)

**Template:**
- Template stored in Supabase database (`document_templates` table)
- Placeholders: `{{CLIENT_NAME}}` (from `client_entities.entity_name`), `{{TAX_YEAR}}` (dynamic)

**Signatures:**
- Stored in separate `engagement_signatures` table
- Links to `profiles.user_id` (authenticated user who signed)
- Signature capture: Hybrid (canvas pad on mobile, typed name as fallback)
- Signature data: Image/data stored in `engagement_signatures` table

**Required Signatures Logic:**
- Default: `required_signatures_count = 1` (Single filing status assumed)
- If filing status changes to MFJ → update `required_signatures_count = 2`
- Existing signatures are NOT invalidated when filing status changes
- Status transitions:
  - `partially_signed`: When 1 signature exists AND `required_signatures_count = 2`
  - `fully_signed`: When signature count = `required_signatures_count`

**Signed PDF Generation:**
- Only generated when `engagement_status = fully_signed`
- n8n generates signed PDF with all signatures embedded
- Stored as separate file (e.g., `engagement_letter_signed.pdf`)
- Original PDF never replaced (audit requirement)
- Both PDFs stored in Tax Documents folder

**Storage:**
- Original PDF: `client-files/{client_entity_id}/tax_documents/engagement_letter_{tax_year}.pdf`
- Signed PDF: `client-files/{client_entity_id}/tax_documents/engagement_letter_signed_{tax_year}.pdf`
- Paths referenced in `entity_tax_year` metadata

Does this match your expectations? Should we move on to the Documents Confirmation Letter next?

---

**User**

This plan matches expectations with three adjustments:

Don’t store signature image/data directly in engagement_signatures; store signature files in Supabase Storage (private) and reference the storage path + metadata in the table.

Avoid JSONB “metadata” for engagement letter paths—use explicit columns (or a dedicated table) for original/signed PDF paths.

Update storage paths to be anchored on client_id and entity_tax_year_id (not client_entity_id), e.g. client-files/{client_id}/tax_documents/{entity_tax_year_id}/....
After these edits, the Engagement Letter plan is approved. Yes, move on to the Documents Confirmation Letter next.

---

**Cursor**


Noted the three adjustments:
1. Signature files stored in Supabase Storage (private), paths referenced in `engagement_signatures` table
2. Explicit columns (or dedicated table) for PDF paths, not JSONB metadata
3. Storage paths: `client-files/{client_id}/tax_documents/{entity_tax_year_id}/...`

Engagement Letter plan approved with these adjustments.

Moving to the Documents Confirmation Letter. Reviewing the template:


---

**User**

Store the Documents Confirmation Letter PDF in the existing Tax Documents system folder (to keep all tax-year artifacts together). Persist the storage path in the database via a dedicated table or explicit columns for auditability and versioning (avoid JSON metadata).

---

**Cursor**


Clarifying the remaining details:


---

**User**

Store the confirmation letter PDF as a normal row in the existing documents table (type = doc_confirmation_letter, system_generated = true) linked to entity_tax_year. This keeps all files in one consistent model, supports versioning, and avoids adding one-off path columns or new tables.

---

**Cursor**


Using the existing `documents` table with `type = 'doc_confirmation_letter'` and `system_generated = true` keeps it consistent. Clarifying the remaining details:


---

**User**

On regeneration, create a new documents row (don’t overwrite). Include a version field and increment it each time. Keep prior versions for audit/history; mark only the latest as is_current = true (optional).

---

**Cursor**


Noted: versioning via new document rows with a `version` field and `is_current` flag. Clarifying the remaining details:



## Documents Confirmation Letter - Implementation Plan

**Generation:**
- Staff manually triggers generation (after reviewing documents)
- n8n generates PDF from template stored in Supabase database
- PDF stored as document row: `type = 'doc_confirmation_letter'`, `system_generated = true`
- Linked to `entity_tax_year_id`

**Storage:**
- Stored in Tax Documents system folder
- Path: `client-files/{client_id}/tax_documents/{entity_tax_year_id}/doc_confirmation_letter_v{version}.pdf`
- Document row in `documents` table with version tracking

**Versioning:**
- On regeneration: create new document row (don't overwrite)
- `version` field increments each time
- `is_current = true` flag marks latest version
- Prior versions kept for audit/history

**Template Population:**
- Hybrid approach: Auto-populate lists from `checklist_items` and `documents` table
- Staff can edit/curate lists before generating PDF
- Lists: W-2 Forms, 1099 Forms, Other Documents, Not Applicable items

**Signature:**
- Same method as Engagement Letter (hybrid: canvas pad + typed fallback)
- Signature file stored in Supabase Storage (private)
- Signature path stored in `doc_receipt_confirmations` table
- Links to `profiles.user_id` (authenticated user)

**Signed PDF:**
- Generated immediately when signature is submitted
- n8n generates signed PDF with signature embedded
- Stored as separate document row (or new version of confirmation letter)
- Original unsigned PDF preserved

Does this match your expectations? Should we move on to the Privacy Policy next?

---

**User**

Looks good with two adjustments:

For the Documents Confirmation Letter, use typed name + timestamp (and authenticated user_id) as the acknowledgment; no drawn signature needed. Store acknowledgment on doc_receipt_confirmations.

Store the signed PDF as a new documents row (never overwrite) and link it to the specific unsigned letter version via source_document_id.
After these edits, approved. Yes, move on to the Privacy Policy next.

---

**Cursor**


Noted two adjustments:
1. Documents Confirmation acknowledgment: typed name + timestamp + authenticated `user_id` (no drawn signature); stored in `doc_receipt_confirmations`.
2. Signed PDF: new `documents` row (never overwrite), linked via `source_document_id` to the unsigned letter version.

Documents Confirmation Letter plan approved with these adjustments.

Moving to the Privacy Policy. Reviewing the template:


---

**User**

Support versioning for the Privacy Policy: track versions with effective dates and allow viewing prior versions. Do not require user acknowledgment or block functionality.

---

**Cursor**


Privacy Policy: versioned with effective dates, prior versions viewable, no acknowledgment required, no blocking. Clarifying where it should be accessible:



## Privacy Policy - Implementation Plan

**Storage:**
- Stored as text/markdown in database table (e.g., `legal_documents` or `privacy_policies`)
- Table structure: `id`, `version`, `effective_date`, `content` (text/markdown), `created_at`, `is_current`

**Versioning:**
- Track versions with effective dates
- Allow viewing prior versions
- Mark current version with `is_current = true` or `effective_date <= NOW() AND (next_version.effective_date > NOW() OR next_version IS NULL)`

**Access:**
- Accessible in Settings/legal section
- Footer link on all pages (web pattern)
- No onboarding requirement
- No acknowledgment required
- No blocking functionality

**Display:**
- Render markdown to HTML for display
- Show current version by default
- Allow users to view prior versions (dropdown or version history)

---

## Summary of All Document Templates

1. **Tax Season Start Email** — Automated email sent when `invite_status = queued`
2. **Engagement Letter** — Auto-generated PDF on entity creation, signatures in `engagement_signatures` table
3. **Documents Confirmation Letter** — Staff-triggered PDF, typed acknowledgment in `doc_receipt_confirmations`
4. **Privacy Policy** — Versioned text in database, accessible in settings and footer

All four documents are approved. Should I update the plan with these details, or proceed to implementation?

---

**User**

You are updating our Fine Form Accounting app plan to match our authoritative PDFs.

Hard rules:
1) No onboarding is required for existing clients: we will bulk import a full client table; invite flow starts tax-year work for existing clients. Onboarding for brand-new clients will be added later.
2) Engagement Letter is non-blocking for access.
3) Document Confirmation Letter is NOT required for filing/readiness. It is optional. If signed, we must store signature + timestamp + generated PDF and keep it immutable and audit logged.
4) Use canonical terminology everywhere: “Tax Season Start Email”, “Engagement Letter”, “Document Receipt Confirmation”, “Tax Documents folder”.

Please update the plan/spec text to reflect these rules explicitly and remove any implied onboarding steps for existing clients.


---

**Cursor**


Updating the plan to reflect these rules. Reviewing the current plan and making the necessary changes:



Searching for sections that need updates:



Updating the plan with these rules. Making targeted changes:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `attempt_count`, `last_error`

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_entity_id}/{folder_id}/{filename}`
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Confirmation State:**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```


Adding a section on client onboarding and bulk import, and updating the Engagement Letter section:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Client Onboarding**
- **Existing clients:** No onboarding required. Clients will be bulk imported into the system. Invite flow (Tax Season Start Email) initiates tax-year work for existing clients.
- **New clients:** Onboarding will be added in a future phase. For now, focus on existing client workflows.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement State:**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
```


Checking the correct file path:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Client Onboarding**
- **Existing clients:** No onboarding required. Clients will be bulk imported into the system. Invite flow (Tax Season Start Email) initiates tax-year work for existing clients.
- **New clients:** Onboarding will be added in a future phase. For now, focus on existing client workflows.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```


Updating terminology and adding a bulk import section. Checking Workflow 1 references:



Updating Workflow 1 and adding a bulk import section:


```markdown
### 2.3 Workflow 1 — Tax Season Start Email Control
**Pages/Components:**
- Entity selection interface
- Tax Season Start Email queue dashboard
- Email send controls (triggers n8n webhook for Tax Season Start Email)
- Delivery logs view (from `email_delivery_log` table)

**API Routes:**
- `POST /api/invites/send` - triggers n8n webhook to send Tax Season Start Email
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rule:** Existing clients are bulk imported (no onboarding). Tax Season Start Email initiates tax-year work for existing clients.
```

```markdown
### 2.1 Project Setup
- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)
- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- Create `entity_tax_year` records for imported clients
- **Hard Rule:** No onboarding required for bulk-imported clients. Tax Season Start Email flow initiates tax-year work.
```


Reading the current state and making the remaining updates:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Client Onboarding**
- **Existing clients:** No onboarding required. Clients will be bulk imported into the system. Invite flow (Tax Season Start Email) initiates tax-year work for existing clients.
- **New clients:** Onboarding will be added in a future phase. For now, focus on existing client workflows.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- Create `entity_tax_year` records for imported clients
- **Hard Rule:** No onboarding required for bulk-imported clients. Tax Season Start Email flow initiates tax-year work.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Invite Control

**Pages/Components:**

- Entity selection interface
- Invite queue dashboard
- Invite send controls (triggers n8n webhook)
- Delivery logs view

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook
- `GET /api/invites/status` - checks delivery status

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Client Onboarding**
- **Existing clients:** No onboarding required. Clients will be bulk imported into the system. Invite flow (Tax Season Start Email) initiates tax-year work for existing clients.
- **New clients:** Onboarding will be added in a future phase. For now, focus on existing client workflows.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- Create `entity_tax_year` records for imported clients
- **Hard Rule:** No onboarding required for bulk-imported clients. Tax Season Start Email flow initiates tax-year work.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Pages/Components:**

- Entity selection interface
- Tax Season Start Email queue dashboard
- Email send controls (triggers n8n webhook for Tax Season Start Email)
- Delivery logs view (from `email_delivery_log` table)

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook to send Tax Season Start Email
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rule:** Existing clients are bulk imported (no onboarding). Tax Season Start Email initiates tax-year work for existing clients.

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation

**Screens:**

- Prompt at checklist completion
- Signature capture
- One signature per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit confirmation

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```


Updating the Document Receipt Confirmation section in Phase 3:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Client Onboarding**
- **Existing clients:** No onboarding required. Clients will be bulk imported into the system. Invite flow (Tax Season Start Email) initiates tax-year work for existing clients.
- **New clients:** Onboarding will be added in a future phase. For now, focus on existing client workflows.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- Create `entity_tax_year` records for imported clients
- **Hard Rule:** No onboarding required for bulk-imported clients. Tax Season Start Email flow initiates tax-year work.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Pages/Components:**

- Entity selection interface
- Tax Season Start Email queue dashboard
- Email send controls (triggers n8n webhook for Tax Season Start Email)
- Delivery logs view (from `email_delivery_log` table)

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook to send Tax Season Start Email
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rule:** Existing clients are bulk imported (no onboarding). Tax Season Start Email initiates tax-year work for existing clients.

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Signing

**Screens:**

- Engagement letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch letter
- `POST /api/engagement/sign` - submit signature

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Client Onboarding**
- **Existing clients:** No onboarding required. Clients will be bulk imported into the system. Invite flow (Tax Season Start Email) initiates tax-year work for existing clients.
- **New clients:** Onboarding will be added in a future phase. For now, focus on existing client workflows.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- Create `entity_tax_year` records for imported clients
- **Hard Rule:** No onboarding required for bulk-imported clients. Tax Season Start Email flow initiates tax-year work.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Pages/Components:**

- Entity selection interface
- Tax Season Start Email queue dashboard
- Email send controls (triggers n8n webhook for Tax Season Start Email)
- Delivery logs view (from `email_delivery_log` table)

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook to send Tax Season Start Email
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rule:** Existing clients are bulk imported (no onboarding). Tax Season Start Email initiates tax-year work for existing clients.

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter
- `POST /api/engagement/sign` - submit signature

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status.

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```


Adding a summary of hard rules at the beginning of the plan:


```markdown
**Core Principles:**
- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**
1. **No onboarding for existing clients:** Clients will be bulk imported. Tax Season Start Email initiates tax-year work for existing clients. Onboarding for new clients will be added later.
2. **Engagement Letter is NON-BLOCKING:** Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Does NOT affect filing/readiness. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **No onboarding for existing clients:** Clients will be bulk imported. Tax Season Start Email initiates tax-year work for existing clients. Onboarding for new clients will be added later.
2. **Engagement Letter is NON-BLOCKING:** Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Does NOT affect filing/readiness. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Client Onboarding**
- **Existing clients:** No onboarding required. Clients will be bulk imported into the system. Invite flow (Tax Season Start Email) initiates tax-year work for existing clients.
- **New clients:** Onboarding will be added in a future phase. For now, focus on existing client workflows.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- Create `entity_tax_year` records for imported clients
- **Hard Rule:** No onboarding required for bulk-imported clients. Tax Season Start Email flow initiates tax-year work.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Pages/Components:**

- Entity selection interface
- Tax Season Start Email queue dashboard
- Email send controls (triggers n8n webhook for Tax Season Start Email)
- Delivery logs view (from `email_delivery_log` table)

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook to send Tax Season Start Email
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rule:** Existing clients are bulk imported (no onboarding). Tax Season Start Email initiates tax-year work for existing clients.

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter
- `POST /api/engagement/sign` - submit signature

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status.

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```


## Updates Made:

1. **Hard Rules Section Added** — Added explicit hard rules at the top of the Architecture Overview section.

2. **Client Onboarding** — Added note that existing clients are bulk imported with no onboarding; Tax Season Start Email initiates tax-year work.

3. **Engagement Letter** — Marked as NON-BLOCKING; does not affect `ready_for_prep`; clients can access all features regardless of signature status.

4. **Document Receipt Confirmation** — Marked as OPTIONAL; removed from `ready_for_prep` calculation; if signed, must be stored immutably with audit logging.

5. **Canonical Terminology** — Updated throughout:
   - "Tax Season Start Email" (not "invite email")
   - "Engagement Letter" (not "engagement")
   - "Document Receipt Confirmation" (not "document confirmation")
   - "Tax Documents folder" (canonical name)

6. **Storage Paths** — Updated to use `{client_id}/tax_documents/{entity_tax_year_id}/...` structure.

7. **ready_for_prep Logic** — Removed Document Receipt Confirmation from calculation; Engagement Letter does not block.

8. **Bulk Import Section** — Added Phase 2.1.1 for bulk client import functionality.

9. **Workflow 1** — Updated to use "Tax Season Start Email" terminology.

10. **Attempt Count** — Removed from `entity_tax_year`; derived from `email_delivery_log` table.

The plan now reflects these hard rules. Ready for implementation.

---

**User**

Revise the Tax Season Start / Invite section of the PLAN to reflect the following behavior:

- Tax Season Start is initiated for existing clients already present in the system.
- The invite action:
  - Activates or ensures the entity + tax year container exists
  - Triggers visibility of the Engagement Letter and tax checklist immediately upon login
  - Sends the Tax Season Start Email with the app link
- No onboarding steps, intake forms, or account creation flows are involved for existing clients.
- Client access is immediate upon login.

Ensure the plan clearly states that “invite” ≠ “onboarding” for existing clients and that onboarding is a future concern only for newly added clients.


---

**Cursor**


Updating the Tax Season Start / Invite section to reflect this behavior. Locating and updating the relevant sections:



Updating the relevant sections:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Does NOT affect filing/readiness. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Client Onboarding**
- **Existing clients:** No onboarding required. Clients will be bulk imported into the system. Invite flow (Tax Season Start Email) initiates tax-year work for existing clients.
- **New clients:** Onboarding will be added in a future phase. For now, focus on existing client workflows.

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- Create `entity_tax_year` records for imported clients
- **Hard Rule:** No onboarding required for bulk-imported clients. Tax Season Start Email flow initiates tax-year work.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Pages/Components:**

- Entity selection interface
- Tax Season Start Email queue dashboard
- Email send controls (triggers n8n webhook for Tax Season Start Email)
- Delivery logs view (from `email_delivery_log` table)

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook to send Tax Season Start Email
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rule:** Existing clients are bulk imported (no onboarding). Tax Season Start Email initiates tax-year work for existing clients.

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter
- `POST /api/engagement/sign` - submit signature

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status.

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Does NOT affect filing/readiness. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- Create `entity_tax_year` records for imported clients
- **Hard Rule:** No onboarding required for bulk-imported clients. Tax Season Start Email flow initiates tax-year work.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Pages/Components:**

- Entity selection interface
- Tax Season Start Email queue dashboard
- Email send controls (triggers n8n webhook for Tax Season Start Email)
- Delivery logs view (from `email_delivery_log` table)

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook to send Tax Season Start Email
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rule:** Existing clients are bulk imported (no onboarding). Tax Season Start Email initiates tax-year work for existing clients.

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter
- `POST /api/engagement/sign` - submit signature

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status.

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Does NOT affect filing/readiness. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- Create `entity_tax_year` records for imported clients
- **Hard Rule:** No onboarding required for bulk-imported clients. Tax Season Start Email flow initiates tax-year work.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Pages/Components:**

- Entity selection interface
- Tax Season Start Email queue dashboard
- Email send controls (triggers n8n webhook for Tax Season Start Email)
- Delivery logs view (from `email_delivery_log` table)

**API Routes:**

- `POST /api/invites/send` - triggers n8n webhook to send Tax Season Start Email
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rule:** Existing clients are bulk imported (no onboarding). Tax Season Start Email initiates tax-year work for existing clients.

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter
- `POST /api/engagement/sign` - submit signature

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status.

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Does NOT affect filing/readiness. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- Create `entity_tax_year` records for imported clients
- **Hard Rule:** No onboarding required for bulk-imported clients. Tax Season Start Email flow initiates tax-year work.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter
- `POST /api/engagement/sign` - submit signature

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status.

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Does NOT affect filing/readiness. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter
- `POST /api/engagement/sign` - submit signature

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status.

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```


Updating the client app section to reflect immediate access:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Does NOT affect filing/readiness. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter
- `POST /api/engagement/sign` - submit signature

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status.

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login
```


Checking the current state and updating the Engagement Letter section:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Does NOT affect filing/readiness. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```


Updated the Tax Season Start / Invite section. Summary of changes:

## Updates Made:

1. **Hard Rules Section (Top of Plan)** — Updated to state:
   - Tax Season Start is for existing clients already in the system
   - Invite action activates/ensures entity + tax year container, triggers visibility, sends email
   - No onboarding steps, intake forms, or account creation flows
   - Client access is immediate upon login
   - "Invite" ≠ "onboarding" for existing clients

2. **Phase 1 - Client Onboarding Section** — Expanded to clarify:
   - Tax Season Start is for existing clients
   - Invite action behavior (3 steps)
   - "Invite" ≠ "onboarding" distinction
   - No onboarding steps for existing clients
   - Immediate access upon login

3. **Phase 1 - Invite State Section** — Updated to document:
   - Behavior when invite is triggered (5 steps)
   - Ensures container exists
   - Makes Engagement Letter and checklist visible
   - Sends email
   - Immediate client access

4. **Phase 2 - Workflow 1 Section** — Expanded with:
   - Purpose statement
   - Invite action behavior (3 steps)
   - Hard rules emphasizing "Invite" ≠ "onboarding"
   - No onboarding steps for existing clients

5. **Phase 2 - Bulk Import Section** — Updated to note:
   - `entity_tax_year` records created by invite action, not bulk import
   - Invite action makes Engagement Letter + checklist visible immediately

6. **Phase 3 - Client App Authentication** — Added section:
   - Immediate access for existing clients
   - No onboarding steps
   - Engagement Letter and checklist visible immediately
   - No gates, no waiting

7. **Phase 3 - Engagement Letter Section** — Updated to state:
   - Visible immediately upon login if invite triggered
   - No onboarding required

The plan now states that "Invite" ≠ "onboarding" for existing clients, and that onboarding is a future concern only for newly added clients.

---

**User**

Update the plan to explicitly state:

- Engagement Letters are scoped per (client_entity_id + tax_year).
- Engagement Letters are stored as documents in the Tax Documents system folder.
- Engagement Letters support versioning, partial signatures, and multi-signer flows.
- Prior versions are retained for audit.
- Engagement Letter status is tracked independently from readiness and does not block any workflow.

This is a planning clarification only — do not add implementation detail.


---

**Cursor**


Updating the plan to explicitly state these Engagement Letter clarifications. Locating the relevant sections:



Adding explicit Engagement Letter clarifications to the relevant sections:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Does NOT affect filing/readiness. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Does NOT affect filing/readiness. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Does NOT affect filing/readiness. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter, Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Does NOT affect filing/readiness. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter (scoped per client_entity_id + tax_year, supports versioning), Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```


Updated the plan with explicit Engagement Letter clarifications. Summary of changes:

## Updates Made:

1. **Hard Rules Section (Top of Plan)** — Updated Engagement Letter rule to include:
   - Scoped per `(client_entity_id + tax_year)`
   - Stored as documents in Tax Documents system folder
   - Support versioning, partial signatures, and multi-signer flows
   - Prior versions retained for audit
   - Status tracked independently from readiness

2. **Phase 1 - Engagement Letter State Section** — Added "Engagement Letter Planning Clarifications" with all five points

3. **Phase 3 - Workflow 2 Section** — Added "Planning Clarifications" section with all five points before the Hard Rules

4. **Tax Documents Folder Description** — Updated to note that Engagement Letters are stored there and support versioning

These clarifications are now explicitly stated in the plan as planning-level statements, without implementation detail. The plan now clearly documents that Engagement Letters are scoped per entity + tax year, stored in Tax Documents folder, support versioning and multi-signer flows, retain prior versions, and do not block workflows.

---

**User**

Update the Document Receipt Confirmation section of the PLAN to clarify:

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted.
- Items marked “Not Applicable” are considered resolved but are NOT documents.
- Confirmation is OPTIONAL and NOT required for filing or readiness.
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only).
- Staff may record a confirmation on behalf of a client when necessary.

Explicitly state that confirmation does NOT block uploads, messaging, preparation, review, or filing.


---

**Cursor**


Updating the Document Receipt Confirmation section with these clarifications. Locating the relevant sections:



Updating all Document Receipt Confirmation sections:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Does NOT affect filing/readiness. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter (scoped per client_entity_id + tax_year, supports versioning), Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted. Items marked "Not Applicable" are considered resolved but are NOT documents. Confirmation is OPTIONAL and NOT required for filing or readiness. When captured, stores generated document, document lists at time of acknowledgment, signer identity and timestamp. Records are immutable (append-only). Staff may record on behalf of client. Does NOT block uploads, messaging, preparation, review, or filing. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter (scoped per client_entity_id + tax_year, supports versioning), Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted. Items marked "Not Applicable" are considered resolved but are NOT documents. Confirmation is OPTIONAL and NOT required for filing or readiness. When captured, stores generated document, document lists at time of acknowledgment, signer identity and timestamp. Records are immutable (append-only). Staff may record on behalf of client. Does NOT block uploads, messaging, preparation, review, or filing. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter (scoped per client_entity_id + tax_year, supports versioning), Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness.**

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
**Hard Rule: Document Receipt Confirmation is OPTIONAL and does NOT affect readiness. Confirmation does NOT block uploads, messaging, preparation, review, or filing.**
```


Finding and updating the remaining section:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted. Items marked "Not Applicable" are considered resolved but are NOT documents. Confirmation is OPTIONAL and NOT required for filing or readiness. When captured, stores generated document, document lists at time of acknowledgment, signer identity and timestamp. Records are immutable (append-only). Staff may record on behalf of client. Does NOT block uploads, messaging, preparation, review, or filing. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: engagement fully signed, checklist complete, doc confirmation signed, questionnaire submitted, ID valid
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter (scoped per client_entity_id + tax_year, supports versioning), Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect readiness. Confirmation does NOT block uploads, messaging, preparation, review, or filing.

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Notes:**
- Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2)
- Document Receipt Confirmation is OPTIONAL and does NOT affect readiness (does not block uploads, messaging, preparation, review, or filing)

All true → `ready_for_prep = true`
```


Fixing the incorrect reference to doc confirmation in the readiness calculation:


```markdown
**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: checklist complete, questionnaire submitted, ID valid
- **Note:** Engagement Letter and Document Receipt Confirmation are NOT checked (both are optional/non-blocking)
```


Reading the current state and updating:



Updating the earlier section that still has incorrect information:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted. Items marked "Not Applicable" are considered resolved but are NOT documents. Confirmation is OPTIONAL and NOT required for filing or readiness. When captured, stores generated document, document lists at time of acknowledgment, signer identity and timestamp. Records are immutable (append-only). Staff may record on behalf of client. Does NOT block uploads, messaging, preparation, review, or filing. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: checklist complete, questionnaire submitted, ID valid
- **Note:** Engagement Letter and Document Receipt Confirmation are NOT checked (both are optional/non-blocking)
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter (scoped per client_entity_id + tax_year, supports versioning), Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect readiness. Confirmation does NOT block uploads, messaging, preparation, review, or filing.

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```


Updated the Document Receipt Confirmation sections. Summary of changes:

## Updates Made:

1. **Hard Rules Section (Top of Plan)** — Updated to include:
   - Year-level attestation clarification
   - "Not Applicable" items are resolved but NOT documents
   - OPTIONAL and NOT required for filing or readiness
   - What gets stored when captured
   - Immutable records (append-only)
   - Staff can record on behalf of client
   - Explicitly states it does NOT block uploads, messaging, preparation, review, or filing

2. **Phase 1 - Document Receipt Confirmation State Section** — Added "Document Receipt Confirmation Planning Clarifications" with all points and explicit non-blocking rules

3. **Phase 1 - Canonical Gates Section** — Added planning clarifications and explicit non-blocking statement

4. **Phase 1 - compute_ready_for_prep Function** — Fixed incorrect reference that included doc confirmation in checks; now correctly excludes it

5. **Phase 3 - Workflow 2 Section** — Added planning clarifications section with all points and explicit non-blocking rules

The plan now states that Document Receipt Confirmation:
- Is a year-level attestation (not a document requirement)
- "Not Applicable" items are resolved but NOT documents
- Is OPTIONAL and does NOT affect readiness
- Stores generated document, document lists, signer identity, and timestamp
- Records are immutable (append-only)
- Staff can record on behalf of client
- Does NOT block uploads, messaging, preparation, review, or filing

All clarifications are now explicitly stated in the plan.

---

**User**

Normalize terminology throughout the PLAN to match authoritative documents exactly.

Enforce the following canonical terms:
- “Tax Season Start Email”
- “Engagement Letter”
- “Document Receipt Confirmation”
- “Tax Documents folder”

Remove or replace vague terms such as:
- “confirmation artifact”
- “authorization document”
- “engagement artifact”

Add a short “Terminology Lock” note stating that these terms are authoritative and must be used consistently across schema, code, automation, and UI.


---

**Cursor**


Normalizing terminology throughout the plan. Searching for all instances and vague alternatives:



Adding a Terminology Lock section and normalizing terminology. Searching for vague terms and variations:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Terminology Lock (Authoritative):**

The following terms are authoritative and must be used consistently across schema, code, automation, and UI:

- **"Tax Season Start Email"** (not "invite email", "tax season email", or variations)
- **"Engagement Letter"** (not "engagement", "engagement document", or variations)
- **"Document Receipt Confirmation"** (not "confirmation", "confirmation artifact", "document confirmation", or variations)
- **"Tax Documents folder"** (not "tax documents folder", "Tax Documents", or variations - exact capitalization)

These canonical terms must be used in:
- Database table names, column names, and constraints
- API endpoints and function names
- n8n workflow names and variables
- UI labels, headings, and user-facing text
- Documentation and comments

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted. Items marked "Not Applicable" are considered resolved but are NOT documents. Confirmation is OPTIONAL and NOT required for filing or readiness. When captured, stores generated document, document lists at time of acknowledgment, signer identity and timestamp. Records are immutable (append-only). Staff may record on behalf of client. Does NOT block uploads, messaging, preparation, review, or filing. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: checklist complete, questionnaire submitted, ID valid
- **Note:** Engagement Letter and Document Receipt Confirmation are NOT checked (both are optional/non-blocking)
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter (scoped per client_entity_id + tax_year, supports versioning), Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect readiness. Confirmation does NOT block uploads, messaging, preparation, review, or filing.

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```


Continuing terminology normalization:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement Letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build document receipt confirmation and e-file authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Terminology Lock (Authoritative):**

The following terms are authoritative and must be used consistently across schema, code, automation, and UI:

- **"Tax Season Start Email"** (not "invite email", "tax season email", or variations)
- **"Engagement Letter"** (not "engagement", "engagement document", or variations)
- **"Document Receipt Confirmation"** (not "confirmation", "confirmation artifact", "document confirmation", or variations)
- **"Tax Documents folder"** (not "tax documents folder", "Tax Documents", or variations - exact capitalization)

These canonical terms must be used in:
- Database table names, column names, and constraints
- API endpoints and function names
- n8n workflow names and variables
- UI labels, headings, and user-facing text
- Documentation and comments

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted. Items marked "Not Applicable" are considered resolved but are NOT documents. Confirmation is OPTIONAL and NOT required for filing or readiness. When captured, stores generated document, document lists at time of acknowledgment, signer identity and timestamp. Records are immutable (append-only). Staff may record on behalf of client. Does NOT block uploads, messaging, preparation, review, or filing. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: checklist complete, questionnaire submitted, ID valid
- **Note:** Engagement Letter and Document Receipt Confirmation are NOT checked (both are optional/non-blocking)
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter (scoped per client_entity_id + tax_year, supports versioning), Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect readiness. Confirmation does NOT block uploads, messaging, preparation, review, or filing.

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement Letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build Document Receipt Confirmation and E-File Authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Terminology Lock (Authoritative):**

The following terms are authoritative and must be used consistently across schema, code, automation, and UI:

- **"Tax Season Start Email"** (not "invite email", "tax season email", or variations)
- **"Engagement Letter"** (not "engagement", "engagement document", or variations)
- **"Document Receipt Confirmation"** (not "confirmation", "confirmation artifact", "document confirmation", or variations)
- **"Tax Documents folder"** (not "tax documents folder", "Tax Documents", or variations - exact capitalization)

These canonical terms must be used in:
- Database table names, column names, and constraints
- API endpoints and function names
- n8n workflow names and variables
- UI labels, headings, and user-facing text
- Documentation and comments

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted. Items marked "Not Applicable" are considered resolved but are NOT documents. Confirmation is OPTIONAL and NOT required for filing or readiness. When captured, stores generated document, document lists at time of acknowledgment, signer identity and timestamp. Records are immutable (append-only). Staff may record on behalf of client. Does NOT block uploads, messaging, preparation, review, or filing. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: checklist complete, questionnaire submitted, ID valid
- **Note:** Engagement Letter and Document Receipt Confirmation are NOT checked (both are optional/non-blocking)
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents** (canonical name) - stores Engagement Letter (scoped per client_entity_id + tax_year, supports versioning), Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect readiness. Confirmation does NOT block uploads, messaging, preparation, review, or filing.

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```


Checking and fixing "Tax Documents" references:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, invite queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement Letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build Document Receipt Confirmation and E-File Authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Terminology Lock (Authoritative):**

The following terms are authoritative and must be used consistently across schema, code, automation, and UI:

- **"Tax Season Start Email"** (not "invite email", "tax season email", or variations)
- **"Engagement Letter"** (not "engagement", "engagement document", or variations)
- **"Document Receipt Confirmation"** (not "confirmation", "confirmation artifact", "document confirmation", or variations)
- **"Tax Documents folder"** (not "tax documents folder", "Tax Documents", or variations - exact capitalization)

These canonical terms must be used in:
- Database table names, column names, and constraints
- API endpoints and function names
- n8n workflow names and variables
- UI labels, headings, and user-facing text
- Documentation and comments

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted. Items marked "Not Applicable" are considered resolved but are NOT documents. Confirmation is OPTIONAL and NOT required for filing or readiness. When captured, stores generated document, document lists at time of acknowledgment, signer identity and timestamp. Records are immutable (append-only). Staff may record on behalf of client. Does NOT block uploads, messaging, preparation, review, or filing. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: checklist complete, questionnaire submitted, ID valid
- **Note:** Engagement Letter and Document Receipt Confirmation are NOT checked (both are optional/non-blocking)
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents folder** (canonical name) - stores Engagement Letter (scoped per client_entity_id + tax_year, supports versioning), Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect readiness. Confirmation does NOT block uploads, messaging, preparation, review, or filing.

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```

```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, Tax Season Start Email queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement Letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build Document Receipt Confirmation and E-File Authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Terminology Lock (Authoritative):**

The following terms are authoritative and must be used consistently across schema, code, automation, and UI:

- **"Tax Season Start Email"** (not "invite email", "tax season email", or variations)
- **"Engagement Letter"** (not "engagement", "engagement document", or variations)
- **"Document Receipt Confirmation"** (not "confirmation", "confirmation artifact", "document confirmation", or variations)
- **"Tax Documents folder"** (not "tax documents folder", "Tax Documents", or variations - exact capitalization)

These canonical terms must be used in:
- Database table names, column names, and constraints
- API endpoints and function names
- n8n workflow names and variables
- UI labels, headings, and user-facing text
- Documentation and comments

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted. Items marked "Not Applicable" are considered resolved but are NOT documents. Confirmation is OPTIONAL and NOT required for filing or readiness. When captured, stores generated document, document lists at time of acknowledgment, signer identity and timestamp. Records are immutable (append-only). Staff may record on behalf of client. Does NOT block uploads, messaging, preparation, review, or filing. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: checklist complete, questionnaire submitted, ID valid
- **Note:** Engagement Letter and Document Receipt Confirmation are NOT checked (both are optional/non-blocking)
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents folder** (canonical name) - stores Engagement Letter (scoped per client_entity_id + tax_year, supports versioning), Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect readiness. Confirmation does NOT block uploads, messaging, preparation, review, or filing.

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```


Updating remaining terminology issues. Checking for any remaining vague terms:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, Tax Season Start Email queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement Letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build Document Receipt Confirmation and E-File Authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Terminology Lock (Authoritative):**

The following terms are authoritative and must be used consistently across schema, code, automation, and UI:

- **"Tax Season Start Email"** (not "invite email", "tax season email", or variations)
- **"Engagement Letter"** (not "engagement", "engagement document", or variations)
- **"Document Receipt Confirmation"** (not "confirmation", "confirmation artifact", "document confirmation", or variations)
- **"Tax Documents folder"** (not "tax documents folder", "Tax Documents", or variations - exact capitalization)

These canonical terms must be used in:
- Database table names, column names, and constraints
- API endpoints and function names
- n8n workflow names and variables
- UI labels, headings, and user-facing text
- Documentation and comments

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted. Items marked "Not Applicable" are considered resolved but are NOT documents. Confirmation is OPTIONAL and NOT required for filing or readiness. When captured, stores generated document, document lists at time of acknowledgment, signer identity and timestamp. Records are immutable (append-only). Staff may record on behalf of client. Does NOT block uploads, messaging, preparation, review, or filing. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** See "Terminology Lock" section above. Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```

### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
  - Project Name: Fine Form App
  - Project ID: rdhgsrjjlvuyjokpyrbr
  - Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.

**Hard Rule: Tax Season Start / Invite (Existing Clients Only)**

**Tax Season Start is for existing clients already present in the system.**

The invite action:
1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.
- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):
1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.

**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.

**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: checklist complete, questionnaire submitted, ID valid
- **Note:** Engagement Letter and Document Receipt Confirmation are NOT checked (both are optional/non-blocking)
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents folder** (canonical name) - stores Engagement Letter (scoped per client_entity_id + tax_year, supports versioning), Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect readiness. Confirmation does NOT block uploads, messaging, preparation, review, or filing.

Logic:
1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).

All true → `ready_for_prep = true`

**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.

**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
  - the generated confirmation document
  - the document lists used at the time of acknowledgment
  - signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?
4. **Begin Phase 0** - Set up monorepo structure
```


Terminology Lock section added. Summary of updates:

## Updates Made:

1. **Added "Terminology Lock" Section** — Added before Hard Rules with:
   - Authoritative terms: "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder"
   - Explicit "do not use" examples for each term
   - Requirement to use these terms in schema, code, automation, and UI
   - Note that these terms are authoritative and must be used consistently

2. **Normalized Terminology Throughout:**
   - Updated todo item: "Engagement letter" → "Engagement Letter"
   - Updated todo item: "document receipt confirmation" → "Document Receipt Confirmation"
   - Updated todo item: "invite queue" → "Tax Season Start Email queue"
   - Updated: "Tax Documents" → "Tax Documents folder" (when referring to the folder name)

3. **Updated Hard Rules Reference** — Changed "Canonical Terminology" rule to reference the Terminology Lock section

The plan now includes a Terminology Lock section that:
- Lists the four canonical terms
- Provides explicit "do not use" examples
- Requires consistent usage across schema, code, automation, and UI
- States these terms are authoritative

All terminology has been normalized to match the authoritative documents. The plan is ready for implementation with consistent terminology throughout.

---

**User**

Update the PLAN document to add a final, authoritative section titled:

“Canonical Terminology, Scope, and Non-Negotiable Rules”

This section must explicitly lock the following:

### 1. Canonical Terminology (Must Be Used Everywhere)
The following terms are authoritative and must be used consistently across planning, schema, code, UI, and automation:

- “Tax Season Start Email”
- “Engagement Letter”
- “Document Receipt Confirmation”
- “Tax Documents folder”
- “client_entity_id + tax_year” (never account-only scope)

Prohibit alternate or vague terms such as:
- “engagement artifact”
- “authorization document”
- “confirmation artifact”
- “onboarding” (for existing clients)

State clearly that terminology drift is not permitted.

### 2. Engagement Letter — Locked Semantics
- Engagement Letters are scoped per (client_entity_id + tax_year).
- Engagement Letters are stored as documents within the Tax Documents folder.
- Engagement Letters are versioned; prior versions are retained.
- Engagement Letter signature state is tracked but is NON-BLOCKING.
- Engagement Letters do NOT gate uploads, messaging, preparation, review, or filing.

### 3. Document Receipt Confirmation — Locked Semantics
- Document Receipt Confirmation is OPTIONAL.
- It is NOT required for readiness or filing.
- It does NOT block uploads, messaging, preparation, review, or filing.
- Items marked “Not Applicable” are considered resolved, not submitted documents.
- When a confirmation is acknowledged:
  - The record is immutable (append-only).
  - The signed document, signer identity, timestamp, and document lists used at the time of signing are preserved for audit.
- Staff may record a confirmation on behalf of a client when necessary.

### 4. Invite vs Onboarding (Critical Distinction)
- Existing clients are bulk-imported.
- Tax Season Start operates on existing clients.
- “Invite” means activating a tax year and sending the Tax Season Start Email.
- No onboarding flow, intake gating, or account creation occurs for existing clients.
- Onboarding for new clients is explicitly out of scope for this plan.

### 5. Backend Authority
- All readiness, status, and gate logic is computed in the backend.
- Frontend is strictly a renderer of backend state.
- Messaging, status banners, engagement letters, and confirmations never drive workflow state.

End the section with:
“This section is authoritative. Any future plan changes, implementation decisions, or refactors must comply with these rules.”

Do not add implementation detail. This is a plan-level lock only.


---

**Cursor**


Adding the final authoritative section at the end of the plan. Locating the end of the document:



Adding the final authoritative section at the end of the plan:


```markdown
---
name: Fine Form Accounting Platform Build
overview: Build a modern accounting and tax operations platform following the authoritative system blueprint. Replace existing Vue.js admin and Flutter client with Next.js admin/staff app and React Native (Expo) client app, built on Supabase backend with n8n automation, organized as a monorepo.
todos:
  - id: phase0-repo-structure
    content: "Set up monorepo structure: create apps/admin, apps/client, supabase/ directories"
    status: pending
  - id: phase0-delete-legacy-code
    content: Delete existing Vue.js admin code (admin/ directory) and Flutter client code (client/ directory)
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-nextjs
    content: Initialize Next.js 16 admin app in apps/admin with TypeScript, Tailwind, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-init-expo
    content: Initialize Expo React Native app (RN 0.83) in apps/client with TypeScript, Supabase client
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase0-supabase-setup
    content: Initialize Supabase CLI, link to existing project, configure local development
    status: pending
    dependencies:
      - phase0-repo-structure
  - id: phase1-auth-tables
    content: Create profiles and staff_profiles tables with RLS policies and triggers
    status: pending
    dependencies:
      - phase0-supabase-setup
  - id: phase1-client-entity-model
    content: Create accounts, account_users, client_entities tables with RLS
    status: pending
    dependencies:
      - phase1-auth-tables
  - id: phase1-entity-tax-year
    content: Create entity_tax_year table with all state fields and compute_ready_for_prep function
    status: pending
    dependencies:
      - phase1-client-entity-model
  - id: phase1-permissions-rls
    content: Create client_acl, client_staff_permissions, client_staff_assignments tables with comprehensive RLS policies
    status: pending
    dependencies:
      - phase1-entity-tax-year
  - id: phase1-folder-documents
    content: Create folders, folder_acl, documents tables with system folder creation function and storage bucket setup
    status: pending
    dependencies:
      - phase1-permissions-rls
  - id: phase1-checklist-questionnaire
    content: Create checklist_items, questionnaire_sections, questionnaire_answers, doc_receipt_confirmations, efile_authorizations tables
    status: pending
    dependencies:
      - phase1-folder-documents
  - id: phase1-messaging
    content: Create message_threads, thread_participants, messages tables with auto-thread creation on entity_tax_year
    status: pending
    dependencies:
      - phase1-checklist-questionnaire
  - id: phase1-audit-logs
    content: Create status_audit_log, permission_audit_log, document_events tables with triggers
    status: pending
    dependencies:
      - phase1-messaging
  - id: phase2-auth-routing
    content: Implement Supabase Auth integration and role-based routing in Next.js admin app
    status: pending
    dependencies:
      - phase0-init-nextjs
      - phase1-auth-tables
  - id: phase2-workflow1-invites
    content: "Build Workflow 1: Entity selection, Tax Season Start Email queue, send controls, delivery logs"
    status: pending
    dependencies:
      - phase2-auth-routing
  - id: phase2-workflow3-checklist
    content: "Build Workflow 3: Proforma upload, checklist generation trigger, manual editing"
    status: pending
    dependencies:
      - phase2-workflow1-invites
  - id: phase2-workflow6-dashboard
    content: "Build Workflow 6: Internal dashboard with entity list, status filters, blocking indicators, status transitions"
    status: pending
    dependencies:
      - phase2-workflow3-checklist
  - id: phase2-permissions-ui
    content: "Build permissions management UI: restricted client ACL, tax access grants, staff assignments"
    status: pending
    dependencies:
      - phase2-workflow6-dashboard
  - id: phase2-documents-extensions
    content: Build document review interface and extensions/filing operations UI
    status: pending
    dependencies:
      - phase2-permissions-ui
  - id: phase2-messaging-staff
    content: "Build staff-side messaging: thread list, reply interface, unread indicators"
    status: pending
    dependencies:
      - phase2-documents-extensions
  - id: phase3-auth-entity-selection
    content: Implement authentication and entity selection in React Native client app
    status: pending
    dependencies:
      - phase0-init-expo
      - phase1-auth-tables
  - id: phase3-workflow2-engagement
    content: "Build Workflow 2: Engagement Letter view, signature capture (single & MFJ), status display"
    status: pending
    dependencies:
      - phase3-auth-entity-selection
  - id: phase3-workflow4-uploads
    content: "Build Workflow 4: Checklist-based uploads, multi-file support, replace flow, upload queue"
    status: pending
    dependencies:
      - phase3-workflow2-engagement
  - id: phase3-questionnaire
    content: Build questionnaire screens with section progress, draft save, submit
    status: pending
    dependencies:
      - phase3-workflow4-uploads
  - id: phase3-confirmations
    content: Build Document Receipt Confirmation and E-File Authorization screens
    status: pending
    dependencies:
      - phase3-questionnaire
  - id: phase3-downloads-messaging
    content: Build client downloads interface and client-side messaging with real-time subscriptions
    status: pending
    dependencies:
      - phase3-confirmations
  - id: phase3-workflow7-status
    content: "Build Workflow 7: Client-facing status messaging (non-blocking banners/indicators)"
    status: pending
    dependencies:
      - phase3-downloads-messaging
---

# Fine Form Accounting Platform - Implementation Plan

## Architecture Overview

**Target Stack:**

- **Backend**: Supabase (PostgreSQL, Auth, RLS, Storage)
- **Admin/Staff/Client Web**: Next.js (replaces Vue.js)
- **Client Mobile**: React Native with Expo (replaces Flutter)
- **Automation**: n8n (existing setup)
- **Structure**: Monorepo

**Core Principles:**

- Backend as source of truth (all logic in Supabase, no frontend duplication)
- Deterministic gates (binary, computable states)
- Client-controlled (non-blocking uploads, messaging always available)
- Audit-safe (immutable audit logs)

**Terminology Lock (Authoritative):**The following terms are authoritative and must be used consistently across schema, code, automation, and UI:

- **"Tax Season Start Email"** (not "invite email", "tax season email", or variations)
- **"Engagement Letter"** (not "engagement", "engagement document", or variations)
- **"Document Receipt Confirmation"** (not "confirmation", "confirmation artifact", "document confirmation", or variations)
- **"Tax Documents folder"** (not "tax documents folder", "Tax Documents", or variations - exact capitalization)

These canonical terms must be used in:

- Database table names, column names, and constraints
- API endpoints and function names
- n8n workflow names and variables
- UI labels, headings, and user-facing text
- Documentation and comments

**Hard Rules (Authoritative):**

1. **Tax Season Start / Invite for Existing Clients:** Tax Season Start is initiated for existing clients already present in the system. The invite action: (a) activates or ensures the entity + tax year container exists, (b) triggers visibility of Engagement Letter and tax checklist immediately upon login, (c) sends the Tax Season Start Email with app link. **No onboarding steps, intake forms, or account creation flows are involved for existing clients. Client access is immediate upon login.** "Invite" ≠ "onboarding" for existing clients. Onboarding is a future concern only for newly added clients.
2. **Engagement Letter is NON-BLOCKING:** Engagement Letters are scoped per `(client_entity_id + tax_year)`, stored as documents in the Tax Documents system folder, support versioning/partial signatures/multi-signer flows, retain prior versions for audit, and status is tracked independently from readiness. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.
3. **Document Receipt Confirmation is OPTIONAL:** Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted. Items marked "Not Applicable" are considered resolved but are NOT documents. Confirmation is OPTIONAL and NOT required for filing or readiness. When captured, stores generated document, document lists at time of acknowledgment, signer identity and timestamp. Records are immutable (append-only). Staff may record on behalf of client. Does NOT block uploads, messaging, preparation, review, or filing. If signed, signature + timestamp + generated PDF must be stored immutably with audit logging.
4. **Canonical Terminology:** See "Terminology Lock" section above. Use "Tax Season Start Email", "Engagement Letter", "Document Receipt Confirmation", "Tax Documents folder" everywhere.

---

## Phase 0: Foundation & Repo Setup

### 0.1 Monorepo Structure

Create new directory structure:

```javascript
fineform-app/
├── apps/
│   ├── admin/              # Next.js admin/staff app
│   └── client/             # React Native (Expo) client app
├── packages/               # Shared code (optional)
│   └── shared-types/       # TypeScript types shared between apps
├── supabase/               # Supabase migrations, functions, config
│   ├── migrations/
│   ├── functions/
│   └── config.toml
└── docs/                   # Existing documentation (keep)
```



### 0.2 Delete Existing Code

- Delete `admin/` directory entirely (Vue.js admin)
- Delete `client/` directory entirely (Flutter client)

### 0.3 Initialize Next.js Admin App

- Create `apps/admin/` with Next.js 16 (App Router)
- Configure TypeScript, Tailwind CSS
- Set up Supabase client library
- Configure environment variables structure

### 0.4 Initialize React Native Client App

- Create `apps/client/` with Expo (latest SDK compatible with React Native 0.83)
- Configure TypeScript
- Set up Supabase client library
- Configure environment variables

### 0.5 Supabase Project Setup

- Initialize Supabase CLI in `supabase/`
- Link to existing Supabase project:
- Project Name: Fine Form App
- Project ID: rdhgsrjjlvuyjokpyrbr
- Project URL: https://rdhgsrjjlvuyjokpyrbr.supabase.co
- Configure local development environment
- Set up migration structure

### 0.6 Development Environment

- Configure package.json workspaces (if using npm/yarn/pnpm)
- Set up environment variable templates
- Configure gitignore for all apps
- Document local development setup

---

## Phase 1: Backend Core (Supabase = System of Record)

**Critical**: All logic must live in the backend. No frontend may compute readiness, permissions, or gates.

### 1.1 Auth Mirror & Identity Tables

**Tables:**

- `profiles` (mirrors auth.users)
- `id` (UUID, FK to auth.users)
- `user_type` (enum: staff | client)
- `full_name`, `email`, `active`
- `staff_profiles`
- `user_id` (FK → profiles)
- `staff_role` (enum: super_admin | admin | staff)
- `staff_team_reporting` (fine_form | fin_group - reporting only)
- `job_title`, `active`

**RLS Policies:**

- Users can read their own profile
- Staff can read profiles based on permissions
- Super admins can read all profiles

**Database Functions:**

- Trigger to auto-create profile on auth.users insert
- Function to enforce one profile per auth user

### 1.2 Client & Entity Model

**Tables:**

- `accounts` (households/organizations)
- `id`, `display_name`, `created_at`, `updated_at`
- `account_users` (links users to accounts)
- `account_id`, `user_id`, `client_role` (enum: admin | assistant)
- `client_entities` (tax filing units)
- `id`, `account_id`, `entity_name`, `entity_type`, `is_restricted`, `active`

**RLS Policies:**

- Clients can read their own account and entities
- Staff visibility controlled by permissions (see 1.4)

**Critical Rule**: All tax workflows attach to `client_entity_id + tax_year`, never to account alone.**Hard Rule: Tax Season Start / Invite (Existing Clients Only)Tax Season Start is for existing clients already present in the system.**The invite action:

1. Activates or ensures the `entity_tax_year` container exists
2. Triggers visibility of Engagement Letter and tax checklist immediately upon client login
3. Sends the Tax Season Start Email with app download link

**Critical Distinction:** "Invite" ≠ "onboarding" for existing clients.

- **No onboarding steps, intake forms, or account creation flows** are involved for existing clients
- **Client access is immediate upon login** (no gates, no waiting)
- Engagement Letter and checklist are visible immediately after login
- Onboarding is a future concern only for newly added clients (not in scope for initial build)

### 1.3 Entity + Tax Year Container

**Table: `entity_tax_year`** (core container)**Core Identity:**

- `client_entity_id`, `tax_year` (composite unique)

**Tax Season Start / Invite State:**

- `tax_return_expected` (boolean)
- `invite_status` (enum: queued | sent | failed)
- `invite_sent_at`, `last_error`

**Behavior:** When invite is triggered (status set to `queued`):

1. Ensures `entity_tax_year` container exists (creates if needed)
2. Engagement Letter becomes visible to client upon next login
3. Tax checklist becomes visible to client upon next login
4. Tax Season Start Email is sent via n8n with app download link
5. Client has immediate access - no onboarding, no gates, no waiting

**Note:** Attempt count is derived from `email_delivery_log` table, not stored here.**Engagement Letter State (NON-BLOCKING):**

- `engagement_status` (enum: not_started | partially_signed | fully_signed)
- `engagement_signed_at`, `signer_metadata` (JSONB)

**Engagement Letter Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rule:** Engagement Letter is NON-BLOCKING for access. Clients can access all features (uploads, messaging, checklist) regardless of engagement signature status. Engagement status does NOT affect `ready_for_prep`.**Document State:**

- `docs_required_count`, `docs_received_count`
- `checklist_complete_at`

**Document Receipt Confirmation State (OPTIONAL):**

- `doc_confirmation_status` (enum: not_signed | signed)
- `doc_confirmation_signed_at`

**Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
- the generated confirmation document
- the document lists used at the time of acknowledgment
- signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

**Questionnaire State:**

- `questionnaire_status` (enum: not_started | in_progress | completed)
- `questionnaire_completed_at`

**Identification State:**

- `id_status` (enum: not_provided | valid | expired)
- `id_valid_until`

**Extension State:**

- `extension_requested` (boolean), `extension_filed` (boolean)
- `extended_due_date`

**Internal Status:**

- `internal_status` (enum: see Workflow 6)

**Preparation Gate (Materialized):**

- `ready_for_prep` (boolean) - **MUST be computed in database function**

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`**

- Checks: checklist complete, questionnaire submitted, ID valid
- **Note:** Engagement Letter and Document Receipt Confirmation are NOT checked (both are optional/non-blocking)
- Updates `ready_for_prep` column
- Called via trigger on state changes

### 1.4 Permissions & RLS (Critical)

**Tables:**

- `client_acl` (restricted client access)
- `client_entity_id`, `staff_user_id`
- `client_staff_permissions` (tax visibility)
- `client_entity_id`, `staff_user_id`, `can_see_taxes` (boolean)
- `client_staff_assignments` (operational only)
- `client_entity_id`, `staff_user_id`, `role_on_client`, `active`

**RLS Policies (Enforced Everywhere):**

- Restricted clients: Only super_admin visible by default, unless explicit ACL entry
- Tax visibility: Hidden from staff by default
- super_admin → always allowed
- admin → allowed by default
- staff → only if explicitly granted
- Assignments: Control dashboard visibility, NEVER grant permissions

**Database Functions:**

- `check_staff_can_view_client(staff_user_id, client_entity_id)` → boolean
- `check_staff_can_see_taxes(staff_user_id, client_entity_id)` → boolean

### 1.5 Folder & Document System

**Tables:**

- `folders`
- `id`, `client_entity_id`, `name`, `parent_id`, `is_system`
- Visibility flags: `client_visible`, `staff_only`, `admin_only`, `super_admin_only`, `restricted_acl`
- `folder_acl` (for restricted clients)
- `folder_id`, `staff_user_id`
- `documents`
- `id`, `client_entity_id`, `folder_id`, `storage_path`, `display_name`
- `uploaded_by`, `created_at`, `updated_at`

**Storage:**

- Supabase Storage bucket: `client-files`
- Path enforced: `{client_id}/tax_documents/{entity_tax_year_id}/{filename}` (for tax year documents)
- Path enforced: `{client_id}/{folder_id}/{filename}` (for general folders)
- RLS policies on bucket

**System Folders (Auto-created per entity):**

- **Tax Documents folder** (canonical name) - stores Engagement Letter (scoped per client_entity_id + tax_year, supports versioning), Document Receipt Confirmation, and all tax year documents
- Current Year, Work Folder, Bank Accounts, Credit Cards, Payroll, Reports, Assets, Corporate Docs, Past Years, Share Folder (From Client / To Client), Admin (admin_only), Super Admin (super_admin_only)

**Database Function:**

- `create_system_folders(client_entity_id)` - called on entity creation

### 1.6 Checklist, Questionnaire & Confirmations

**Tables:**

- `checklist_items`
- `id`, `entity_tax_year_id`, `item_name`, `description`, `status` (enum: pending | received | n_a)
- `created_at`, `updated_at`
- `checklist_item_files` (links documents to items)
- `checklist_item_id`, `document_id`
- `questionnaire_sections`
- `id`, `entity_tax_year_id`, `section_name`, `order`, `active`
- `questionnaire_answers`
- `id`, `section_id`, `question_key`, `answer_value` (JSONB), `answered_at`
- `doc_receipt_confirmations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)
- `efile_authorizations`
- `id`, `entity_tax_year_id`, `signed_at`, `signed_by`, `signature_data` (JSONB)

**Database Functions:**

- `compute_checklist_completeness(entity_tax_year_id)` → updates `docs_required_count`, `docs_received_count`, `checklist_complete_at`
- Trigger on checklist_item status changes

### 1.7 Canonical Gates (Backend-Owned)

**Database Function: `compute_ready_for_prep(entity_tax_year_id)`Document Receipt Confirmation Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
- the generated confirmation document
- the document lists used at the time of acknowledgment
- signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rule:** Document Receipt Confirmation is OPTIONAL and does NOT affect readiness. Confirmation does NOT block uploads, messaging, preparation, review, or filing.Logic:

1. Checklist complete? (`checklist_complete_at IS NOT NULL`)
2. Questionnaire submitted? (`questionnaire_status = 'completed'`)
3. ID valid? (`id_status = 'valid' AND id_valid_until > NOW()`)

**Note:** Engagement Letter signature is tracked but does NOT block readiness (non-blocking per Workflow 2).All true → `ready_for_prep = true`**Trigger:** Automatically called on any state change affecting readiness.

### 1.8 Workflow Enums & Status Logic

**Internal Status Enum** (Workflow 6):

- `not_started`, `waiting_on_documents`, `in_preparation`, `in_review`, `ready_to_file`, `filed`

**Client Status Mapping** (Workflow 7):

- Database function: `get_client_status(entity_tax_year_id)` → returns status string
- Logic based on checklist, preparation state, filing state

### 1.9 Messaging Infrastructure

**Tables:**

- `message_threads`
- `id`, `client_entity_id`, `tax_year`, `created_at`
- Unique constraint: `(client_entity_id, tax_year)`
- `thread_participants`
- `thread_id`, `user_id`, `role` (enum: client | staff), `added_at`
- `messages`
- `id`, `thread_id`, `sender_id`, `content`, `created_at`, `deleted_at` (soft delete)

**Rules:**

- One thread per entity + tax year (created automatically on entity_tax_year creation)
- Messaging always available, never gated
- Participants determined by permissions (see Workflow 8)

**RLS Policies:**

- Clients can read/write messages in their entity threads
- Staff can read/write messages in threads where they are participants (based on permissions)

**Database Function:**

- `ensure_message_thread(client_entity_id, tax_year)` - called on entity_tax_year creation

### 1.10 Reminders & Scheduling State

**Table: `reminder_state`**

- `id`, `entity_tax_year_id`, `reminder_type` (enum: checklist | engagement | filing_readiness)
- `last_sent_at`, `next_scheduled_at`, `suppressed_until`
- `sent_count`, `suppression_reason`

**Rules:**

- Deterministic scheduling (no duplicate sends)
- Suppression based on state changes

### 1.11 Audit Logging (Mandatory)

**Tables:**

- `status_audit_log`
- `id`, `entity_tax_year_id`, `old_status`, `new_status`, `changed_by`, `changed_at`, `reason`
- `permission_audit_log`
- `id`, `client_entity_id`, `staff_user_id`, `action` (enum: granted | revoked), `changed_by`, `changed_at`
- `document_events`
- `id`, `document_id`, `event_type` (enum: uploaded | replaced | deleted | downloaded), `user_id`, `timestamp`, `metadata` (JSONB)

**Rules:**

- All tables immutable (no updates/deletes)
- Triggers on critical state changes

### Phase 1 Exit Criteria

- ✅ All tables created with proper constraints
- ✅ All RLS policies tested and enforced
- ✅ All database functions implemented and tested
- ✅ `ready_for_prep` computed correctly in backend
- ✅ No logic exists in frontend that should be in backend
- ✅ Audit logging captures all critical events

---

## Phase 2: Admin / Staff App (Next.js)

### 2.1 Project Setup

- Initialize Next.js 16 in `apps/admin/`
- Configure App Router, TypeScript, Tailwind CSS
- Set up Supabase client (server and client components)
- Configure authentication middleware

### 2.1.1 Bulk Client Import (Existing Clients)

- Build bulk import interface for existing clients
- Import clients into `accounts`, `account_users`, `client_entities` tables
- **Note:** `entity_tax_year` records are created/activated by the Tax Season Start invite action, not during bulk import
- **Hard Rule:** Bulk-imported clients are existing clients. No onboarding required. Tax Season Start invite action initiates tax-year work and makes Engagement Letter + checklist visible immediately upon login.

### 2.2 Authentication & Role Routing

- Implement Supabase Auth integration
- Create role-based route protection
- Build login page
- Implement session management
- Handle restricted client visibility

### 2.3 Workflow 1 — Tax Season Start Email Control

**Purpose:** Initiate tax season for existing clients already in the system.**Pages/Components:**

- Entity selection interface (select existing client entities)
- Tax Season Start Email queue dashboard
- Email send controls (triggers invite action)
- Delivery logs view (from `email_delivery_log` table)

**Invite Action Behavior (when triggered):**

1. **Activates/ensures entity + tax year container:** Creates or activates `entity_tax_year` record
2. **Triggers immediate visibility:** Engagement Letter and tax checklist become visible to client upon next login
3. **Sends Tax Season Start Email:** Triggers n8n webhook to send email with app download link

**API Routes:**

- `POST /api/invites/send` - triggers invite action (ensures container, triggers visibility, sends email)
- `GET /api/invites/status` - checks delivery status from `email_delivery_log`

**Hard Rules:**

- **"Invite" ≠ "onboarding"** for existing clients
- **No onboarding steps, intake forms, or account creation flows** for existing clients
- **Client access is immediate upon login** - Engagement Letter and checklist visible immediately
- Onboarding is a future concern only for newly added clients (not in scope)

### 2.4 Workflow 3 — Checklist Control (Internal)

**Pages/Components:**

- Proforma upload interface
- Trigger checklist generation (n8n webhook)
- Review generated checklist items
- Manual checklist editing

**API Routes:**

- `POST /api/checklist/generate` - triggers n8n parsing
- `PUT /api/checklist/items/:id` - update checklist item

### 2.5 Workflow 6 — Internal Dashboard

**Pages/Components:**

- Main dashboard: Entity list by tax year
- Status filters (internal_status, ready_for_prep)
- Blocking indicators (shows why not ready)
- Status transition controls (only when `ready_for_prep = true`)
- Audit log visibility

**API Routes:**

- `GET /api/dashboard/entities` - filtered, paginated list
- `PUT /api/entities/:id/status` - update internal_status (with validation)

### 2.6 Permissions Management

**Pages/Components:**

- Restricted client ACL management
- Tax access grants interface
- Staff assignments interface

**API Routes:**

- `POST /api/permissions/grant` - grant tax access
- `POST /api/permissions/assign` - assign staff to client

### 2.7 Document Review

**Pages/Components:**

- Checklist-based document review
- Document version history
- Secure download (via Supabase Storage signed URLs)

**API Routes:**

- `GET /api/documents/:id/download` - generates signed URL

### 2.8 Extensions & Filing Operations

**Pages/Components:**

- Mark extension filed interface
- Upload acceptance PDF
- Due date recalculation display

**API Routes:**

- `PUT /api/entities/:id/extension` - mark extension filed

### 2.9 Messaging (Firm Side)

**Pages/Components:**

- Thread list (filtered by permissions)
- Reply interface
- Unread indicators

**API Routes:**

- `GET /api/messages/threads` - list threads (permission-filtered)
- `POST /api/messages/send` - send message

### Phase 2 Exit Criteria

- ✅ Staff can operate without spreadsheets
- ✅ Internal status reflects reality
- ✅ Permissions fully enforced via RLS
- ✅ All workflows 1, 3, 6 functional

---

## Phase 3: Client App (React Native / Expo)

### 3.1 Project Setup

- Initialize Expo app in `apps/client/`
- Configure TypeScript
- Set up Supabase client
- Configure authentication

### 3.2 Authentication & Entity Selection

**Screens:**

- Login screen
- Entity switcher (if multiple entities)
- Tax year home screen

**Hard Rule: Immediate Access for Existing Clients**

- **No onboarding steps** - existing clients log in and have immediate access
- **Engagement Letter visible immediately** upon login (if Tax Season Start invite has been triggered)
- **Tax checklist visible immediately** upon login (if Tax Season Start invite has been triggered)
- **No gates, no waiting** - all features (uploads, messaging, checklist) available immediately
- Onboarding is future concern only for newly added clients

### 3.3 Workflow 2 — Engagement Letter Signing (NON-BLOCKING)

**Screens:**

- Engagement Letter view (visible immediately upon login if Tax Season Start invite triggered)
- Signature capture (single & MFJ)
- Partial signature handling
- Status display

**API Integration:**

- `GET /api/engagement/letter` - fetch Engagement Letter (returns immediately if entity_tax_year exists)
- `POST /api/engagement/sign` - submit signature

**Planning Clarifications:**

- Engagement Letters are scoped per `(client_entity_id + tax_year)`
- Engagement Letters are stored as documents in the Tax Documents system folder
- Engagement Letters support versioning, partial signatures, and multi-signer flows
- Prior versions are retained for audit
- Engagement Letter status is tracked independently from readiness and does not block any workflow

**Hard Rules:**

- Engagement Letter is **visible immediately** upon login if Tax Season Start invite has been triggered
- Engagement Letter is **NON-BLOCKING** for access - clients can access all features (uploads, messaging, checklist) regardless of signature status
- No onboarding required - existing clients see Engagement Letter immediately after login

### 3.4 Workflow 4 — Upload Experience (Critical)

**Screens:**

- Checklist-based upload interface
- General upload fallback
- Multi-file per item support
- Replace flow (with confirmation)
- Upload queue & retry logic

**Features:**

- Camera integration for mobile
- File picker
- Progress indicators
- Offline queue (if needed)

**API Integration:**

- Direct Supabase Storage uploads (with RLS)
- `POST /api/documents/match` - attempt checklist matching

### 3.5 Questionnaire

**Screens:**

- Section-based questionnaire UI
- Progress tracking
- Draft save (auto-save)
- Submit confirmation

**API Integration:**

- `GET /api/questionnaire/sections` - fetch sections
- `PUT /api/questionnaire/answers` - save draft
- `POST /api/questionnaire/submit` - final submit

### 3.6 Document Receipt Confirmation (OPTIONAL)

**Screens:**

- Optional prompt at checklist completion (non-blocking)
- Typed name + timestamp acknowledgment (no drawn signature)
- One acknowledgment per year enforcement

**API Integration:**

- `POST /api/confirmations/doc-receipt` - submit Document Receipt Confirmation

**Planning Clarifications:**

- Document Receipt Confirmation is a year-level attestation acknowledging what the client believes they have submitted
- Items marked "Not Applicable" are considered resolved but are NOT documents
- Confirmation is OPTIONAL and NOT required for filing or readiness
- When a confirmation is captured, the system stores:
- the generated confirmation document
- the document lists used at the time of acknowledgment
- signer identity and timestamp
- Confirmation records are immutable once created (append-only)
- Staff may record a confirmation on behalf of a client when necessary

**Hard Rules:**

- Document Receipt Confirmation is OPTIONAL and does NOT affect `ready_for_prep`
- Confirmation does NOT block uploads, messaging, preparation, review, or filing
- If signed, signature + timestamp + generated PDF must be stored immutably with audit logging

### 3.7 E-File Authorization

**Screens:**

- Prompt after draft upload
- Signature capture

**API Integration:**

- `POST /api/authorizations/efile` - submit authorization

### 3.8 Client Downloads

**Screens:**

- Tax Returns access list
- Secure download (via signed URLs)

### 3.9 Messaging (Client Side)

**Screens:**

- Single thread view (per entity + tax year)
- Message list
- Compose message
- Notifications integration

**API Integration:**

- Real-time subscriptions via Supabase Realtime
- `POST /api/messages/send` - send message

### 3.10 Client-Facing Status (Workflow 7)

**Screens:**

- Status banner/indicator
- Clear messaging based on state
- Non-blocking (never prevents actions)

**API Integration:**

- `GET /api/status/client` - fetch computed client status

### Phase 3 Exit Criteria

- ✅ Mobile uploads reliable
- ✅ Client status always clear
- ✅ No blocked clients without explanation
- ✅ All workflows 2, 4, 7, 8 functional

---

## Phase 4: Hardening & Launch

### 4.1 End-to-End Testing

- Test all 8 workflows end-to-end
- Test RLS policies (penetration testing)
- Test reminder duplication prevention
- Test upload stress scenarios
- Validate audit logs

### 4.2 Performance Optimization

- Database query optimization
- Frontend bundle optimization
- Image/document optimization
- Caching strategies

### 4.3 Security Audit

- RLS policy review
- Authentication flow review
- API endpoint security
- Storage bucket security

### 4.4 Documentation

- API documentation
- Deployment guides
- User guides (staff and client)
- Troubleshooting guides

---

## Implementation Notes

### Technology Choices

- **Next.js**: App Router, Server Components for admin efficiency
- **React Native/Expo**: Managed workflow, easy deployment
- **Supabase**: PostgreSQL with RLS, Auth, Storage, Realtime
- **n8n**: Webhook-based integration for automation

### Key Constraints

1. **No frontend logic duplication** - All gates computed in database
2. **RLS everywhere** - Never trust frontend for permissions
3. **Non-blocking** - Clients can always upload and message
4. **Audit-safe** - Every critical action logged

### Migration Strategy

- Delete existing Vue.js admin code (`admin/` directory)
- Delete existing Flutter client code (`client/` directory)
- Build new apps from scratch following blueprint

### Environment Variables

```javascript
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://rdhgsrjjlvuyjokpyrbr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=  # Get from Supabase dashboard
SUPABASE_SERVICE_ROLE_KEY=  # Get from Supabase dashboard

# n8n
N8N_WEBHOOK_URL=

# App URLs
NEXT_PUBLIC_ADMIN_URL=
NEXT_PUBLIC_CLIENT_WEB_URL=
```

---

## Next Steps

1. **Confirm Supabase credentials** - Need project URL and keys
2. **Confirm n8n webhook endpoints** - For invite sending, checklist generation
3. **Review and approve plan** - Any adjustments needed?

---

## Canonical Terminology, Scope, and Non-Negotiable Rules

**Status: AUTHORITATIVE · FINAL · IMPLEMENTATION-LOCKED**

This section establishes the definitive rules that govern all planning, implementation, and future modifications to the Fine Form Accounting platform. These rules are non-negotiable and must be enforced across all phases of development.

### 1. Canonical Terminology (Must Be Used Everywhere)

The following terms are authoritative and must be used consistently across planning, schema, code, UI, and automation:

- **"Tax Season Start Email"**
- **"Engagement Letter"**
- **"Document Receipt Confirmation"**
- **"Tax Documents folder"**
- **"client_entity_id + tax_year"** (never account-only scope)

**Prohibited Terms:**

The following alternate or vague terms are explicitly prohibited:

- "engagement artifact"
- "authorization document"
- "confirmation artifact"
- "onboarding" (for existing clients - see Section 4)
- "invite email" (use "Tax Season Start Email")
- "tax season email" (use "Tax Season Start Email")
- "engagement document" (use "Engagement Letter")
- "confirmation" (use "Document Receipt Confirmation")
- "document confirmation" (use "Document Receipt Confirmation")
- "tax documents folder" (use "Tax Documents folder" - exact capitalization)

**Terminology drift is not permitted.** All database table names, column names, constraints, API endpoints, function names, n8n workflow names, UI labels, headings, user-facing text, documentation, and comments must use these canonical terms exclusively.

### 2. Engagement Letter — Locked Semantics

- Engagement Letters are scoped per `(client_entity_id + tax_year)`.
- Engagement Letters are stored as documents within the Tax Documents folder.
- Engagement Letters are versioned; prior versions are retained.
- Engagement Letter signature state is tracked but is NON-BLOCKING.
- Engagement Letters do NOT gate uploads, messaging, preparation, review, or filing.

### 3. Document Receipt Confirmation — Locked Semantics

- Document Receipt Confirmation is OPTIONAL.
- It is NOT required for readiness or filing.
- It does NOT block uploads, messaging, preparation, review, or filing.
- Items marked "Not Applicable" are considered resolved, not submitted documents.
- When a confirmation is acknowledged:
  - The record is immutable (append-only).
  - The signed document, signer identity, timestamp, and document lists used at the time of signing are preserved for audit.
- Staff may record a confirmation on behalf of a client when necessary.

### 4. Invite vs Onboarding (Critical Distinction)

- Existing clients are bulk-imported.
- Tax Season Start operates on existing clients.
- "Invite" means activating a tax year and sending the Tax Season Start Email.
- No onboarding flow, intake gating, or account creation occurs for existing clients.
- Onboarding for new clients is explicitly out of scope for this plan.

### 5. Backend Authority

- All readiness, status, and gate logic is computed in the backend.
- Frontend is strictly a renderer of backend state.
- Messaging, status banners, engagement letters, and confirmations never drive workflow state.

---

**This section is authoritative. Any future plan changes, implementation decisions, or refactors must comply with these rules.**
```


Added the final authoritative section at the end of the plan. Summary:

## Final Authoritative Section Added

**"Canonical Terminology, Scope, and Non-Negotiable Rules"** section includes:

1. **Canonical Terminology (Must Be Used Everywhere)**
   - Lists all 5 canonical terms
   - Explicitly prohibits alternate/vague terms
   - States that terminology drift is not permitted
   - Requires use across planning, schema, code, UI, and automation

2. **Engagement Letter — Locked Semantics**
   - Scoped per `(client_entity_id + tax_year)`
   - Stored in Tax Documents folder
   - Versioned with prior versions retained
   - NON-BLOCKING
   - Does NOT gate any workflows

3. **Document Receipt Confirmation — Locked Semantics**
   - OPTIONAL
   - NOT required for readiness or filing
   - Does NOT block any workflows
   - "Not Applicable" items are resolved, not documents
   - Immutable records with full audit trail
   - Staff can record on behalf of client

4. **Invite vs Onboarding (Critical Distinction)**
   - Existing clients are bulk-imported
   - "Invite" = activating tax year + sending Tax Season Start Email
   - No onboarding for existing clients
   - Onboarding for new clients is out of scope

5. **Backend Authority**
   - All logic computed in backend
   - Frontend is renderer only
   - Messaging/status never drive workflow state

The section ends with: **"This section is authoritative. Any future plan changes, implementation decisions, or refactors must comply with these rules."**

The plan now has a final authoritative lock on terminology, scope, and non-negotiable rules.

