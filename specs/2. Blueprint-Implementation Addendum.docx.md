**Implementation Addendum — Dual App Architecture (Flutter Client \+ Next.js Admin)**

**Status: FINAL · CLEAN · IMPLEMENTATION-READY**

This addendum defines how the system is implemented when using:

• Flutter (Client App)  
• Next.js (Admin/Staff App)  
• Supabase (single backend \+ storage \+ RLS)  
• n8n (automation \+ delivery engine)

This document does not change Workflows 1–8.  
It clarifies ownership, boundaries, and build guardrails so two frontends remain consistent.

---

**1\. Why an Addendum (Not a Blueprint Rewrite)**

The Tax Season Blueprint is the authoritative system-of-record specification.

This addendum exists to:

• Prevent implementation drift when two apps touch the same data  
• Define write ownership to avoid conflicting updates  
• Clarify backend-canonical gates and shared contracts  
• Document mobile upload reliability expectations

The blueprint remains stable.  
This addendum is the operational build guide for a dual-app setup.

---

**2\. Shared Backend (Single Source of Truth)**

Supabase is the system of record for:

• Auth users \+ profiles  
• Client entities \+ entity\_tax\_year containers  
• Statuses and audit logs  
• Checklist items and questionnaire data  
• Documents table and storage metadata  
• Messaging threads and participants  
• Reminder and extension state

Supabase Storage is the single file store.

n8n is the execution engine for:

• Invite email delivery  
• Reminder delivery  
• Proforma parsing and checklist generation  
• Email notifications for messages and system notices  
• Retry logic and delivery logging

---

**3\. Frontend Roles**

**3.1 Flutter App (Client)**

The Flutter app is the client-facing experience for:

• Engagement signing  
• Checklist viewing and document uploads  
• Questionnaire completion  
• ID upload / ID status visibility  
• Document Receipt Confirmation signing  
• E-file authorization signing  
• In-app messaging (client side)  
• Tax Returns downloads

**3.2 Next.js App (Admin/Staff)**

The Next.js app is the staff-facing system for:

• Entity selection and invite queue control  
• Internal dashboard and status management  
• Proforma uploads and checklist generation controls  
• Document review workflows  
• Extensions filing and acceptance uploads  
• Draft return uploads and e-file request flows  
• Staff assignments and permissions  
• Restricted client ACL management  
• Audit views and operational reporting  
• In-app messaging (firm side)

---

**4\. Write Ownership Rules (Locked)**

To prevent conflicting updates, writes are owned as follows.

**4.1 Client-Owned Writes (Flutter)**

Flutter is permitted to write only client action data:

• Engagement signatures and signer identity  
• Questionnaire answers and submission state  
• ID uploads (where applicable) and client-provided ID metadata  
• Document uploads and explicit replace actions  
• Document Receipt Confirmation signature  
• Extension request action  
• E-file authorization signature  
• Client messages

Flutter must not write internal statuses or admin permission fields.

---

**4.2 Firm-Owned Writes (Next.js)**

Next.js is permitted to write only firm action data:

• Invite queue actions and wave/batch controls  
• Proforma uploads and checklist generation triggers  
• Internal status transitions (Workflow 6\)  
• Extension filed state \+ acceptance uploads  
• Draft return uploads and e-file request actions  
• Staff assignments and tax access grants  
• Restricted client ACL changes  
• Firm messages

Next.js must not write client signatures or client confirmations.

---

**5\. Backend-Canonical Gates (Must Be Central)**

**5.1 Ready for Prep**

Ready for Prep must be backend-canonical.

Implementation rule:

• ready\_for\_prep is computed and maintained in the database (trigger/function/materialized field)  
• Both apps read ready\_for\_prep  
• Neither app re-implements the gate logic independently

Gate requirements remain exactly as defined in Workflow 6\.

---

**5.2 Checklist Completion**

Checklist completion is computed from checklist item statuses.

Implementation rule:

• checklist completion is derived from item states (Received or Not Applicable)  
• Both apps read the derived completion  
• Neither app invents completion locally

---

**6\. Messaging Contract (Shared)**

Messaging is shared across both apps and follows Workflow 8\.

Implementation requirements:

• One thread per client\_entity\_id \+ tax\_year  
• Thread created on first engagement signature  
• Participants are stored in the database  
• System events never appear as chat messages  
• Email notifications are triggered for new messages (via n8n)

---

**7\. Mobile Upload Reliability (Client UX Standard)**

To solve the document collection pain point, the Flutter client experience must include:

• A visible upload queue  
• Clear per-file progress  
• Retry for failed uploads  
• Safe handling of intermittent connectivity  
• Support for multi-file uploads per checklist item  
• A simple “capture multiple photos then submit” flow

These UX requirements do not alter Workflow 4 logic.

---

**8\. Admin Execution Pattern (Recommended)**

For complex admin actions, the Next.js app may use a privileged server layer.

Recommended pattern:

• Client app uses standard Supabase client with RLS  
• Admin app uses Next.js server routes for privileged operations where appropriate  
• All privileged operations still enforce firm-side permission checks

This reduces friction for:

• Restricted clients  
• Tax access grants  
• Administrative overrides

---

**9\. Testing Requirements (Non-Negotiable)**

Before launch, validate with two test users:

• A client user (Flutter)  
• A staff user (Next.js)

Minimum cross-app test cases:

• Invite → client entry  
• Engagement signing (single and MFJ)  
• Checklist creation \+ fallback  
• Upload via checklist and general upload  
• Completion \+ confirmation  
• Reminders pause on extension request  
• Extension filing resets due date  
• Ready for Prep gate accuracy  
• Messaging thread creation \+ notifications  
• Restricted client visibility rules

---

**Final Statement**

This addendum is the authoritative implementation guide for a dual-app build.

• It does not modify Workflows 1–8  
• It clarifies ownership, gates, and shared contracts  
• It prevents implementation drift across Flutter and Next.js

Use this addendum alongside the FINAL Tax Season Blueprint and Workflows 1–8.

