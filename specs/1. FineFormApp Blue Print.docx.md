**1\) What the app is**

A secure client portal \+ internal tax ops system that:

* Invites selected **client entities** into a specific **tax year pipeline**

* Collects signatures, questionnaire data, IDs, and documents

* Enforces a **client-controlled “Ready for Prep” gate**

* Runs reminders/extensions deterministically

* Provides an internal dashboard for status control

* Keeps all client communication in-app (with email notifications)

Workflows define the operational truth: invite → engagement → collect docs → confirm docs → prep → e-file auth → filed. 

Workflow 1 — Tax Season Start

Workflow 2 — Engagement Letter

Workflow 6 — Internal Dashboard…

---

**2\) Core identity \+ account model**

**2.1 Users (everyone logs in)**

**Supabase Auth** is the login source of truth (auth.users), mirrored into:

**profiles**

* id (auth user id)

* user\_type \= staff | client

* full\_name

* email

* active

**2.2 Staff**

**staff\_profiles**

* user\_id

* staff\_role \= super\_admin | admin | staff

* staff\_team\_reporting \= fine\_form | fin\_group *(reporting only, not permissions)*

* job\_title

* phone (optional)

* active

**2.3 Clients (multi-login households \+ multiple entities)**

You intentionally separate:

* **Account** \= household/group container a login can toggle between

* **Entity** \= actual tax client record (1040 household, LLC, S-Corp, etc.)

**accounts**

* id

* display\_name

**account\_users**

* account\_id

* user\_id (client profile id)

* client\_role \= admin | assistant *(owner optional later)*

**client\_entities**

* id

* account\_id

* entity\_name

* entity\_type (1040\_household, llc, s\_corp, etc.)

* status

* created\_at

Key concept (locked in workflows): **everything tax-season attaches to client\_entity\_id \+ tax\_year** (not account+year). 

Workflow 1 — Tax Season Start

Workflow 2 — Engagement Letter

---

**3\) “Entity \+ Tax Year” container (the backbone)**

**entity\_tax\_year (recommended name)**

One row per **(client\_entity\_id, tax\_year)**. This is the anchor for:

* engagement letter state

* checklist \+ uploads \+ confirmation

* questionnaire progress

* ID validity status

* reminders / extension flags

* internal status \+ audit

* messaging thread key

Workflow 1 explicitly creates/ensures this container before anything else. 

Workflow 1 — Tax Season Start

Suggested fields (reflecting your workflows):

* client\_entity\_id

* tax\_year (e.g., 2025\)

* **Invite control**: tax\_return\_expected, invite\_status, invite\_sent\_at, attempt\_count, last\_error 

Workflow 1 — Tax Season Start

* **Engagement**: engagement\_status (not\_started|partially\_signed|fully\_signed), signer timestamps 

Workflow 2 — Engagement Letter

* **Docs**: docs\_required\_count, docs\_received\_count, checklist\_complete\_at

* **Confirmation**: doc\_confirmation\_status, doc\_confirmation\_signed\_at 

Workflow 5 — Reminders, Extensi…

* **Questionnaire**: questionnaire\_status, questionnaire\_completed\_at

* **ID**: id\_status, id\_valid\_until

* **Ready for Prep Gate**: computed or stored ready\_for\_prep \= true/false based on your locked rule 

Workflow 6 — Internal Dashboard…

* **Extension**: extension\_requested, extension\_filed, extended\_due\_date 

Workflow 6 — Internal Dashboard…

* **Primary internal status**: internal\_status enum (below) 

Workflow 6 — Internal Dashboard…

---

**4\) Permissions model (RLS-first)**

**4.1 Default staff visibility (open by default)**

* If client\_entities.is\_restricted \= false → all staff can see client

* If is\_restricted \= true → only **super\_admin** \+ staff listed in **client ACL**

**client\_acl**

* client\_id

* staff\_user\_id

**4.2 Taxes access rule (your special requirement)**

Taxes are hidden from staff by default; admin/super\_admin see by default; staff only by explicit grant.

**client\_staff\_permissions**

* client\_id

* staff\_user\_id

* can\_see\_taxes boolean default false

Rules:

* super\_admin: always can see taxes

* admin: can see taxes for all clients by default (unless client restricted logic overrides granting)

* staff: only if can\_see\_taxes \= true

* If client is restricted: only super\_admin can modify grants

Your workflows reinforce “no other staff gets tax upload notifications” in Year 1\. 

Workflow 5 — Reminders, Extensi…

Workflow 8 — In-App Messaging 

**4.3 “Idir assigned clients” (must be explicit)**

Workflows assume “Idir sees assigned clients” internally. 

Workflow 6 — Internal Dashboard…

So you need a table that becomes RLS source-of-truth:

**client\_staff\_assignments (recommended)**

* client\_id

* staff\_user\_id

* role\_on\_client (e.g., preparer|assistant)

* active

* assigned\_by

* timestamps

This is separate from “can see taxes” and separate from “restricted client ACL”.

---

**5\) Drive-like folder \+ documents system**

You want a database folder tree so you can do:

* right-click add folder

* structured navigation like Drive

* move/rename without moving objects in storage

**Tables**

**folders**

* id

* client\_id (client\_entity\_id)

* name

* parent\_id

* folder\_type (optional)

* is\_system boolean

* Visibility flags:

  * client\_visible

  * staff\_only

  * admin\_only

  * super\_admin\_only

  * restricted\_acl (folder-level ACL)

**folder\_acl**

* folder\_id

* staff\_user\_id

**documents**

* id

* client\_id

* folder\_id

* storage\_path

* display\_name

* uploaded\_by

* timestamps

**Storage bucket**

Bucket: client-files  
Recommended path:  
client-files/{client\_id}/{folder\_id}/{filename}  
(keeps move/rename cheap—no object move required)

---

**6\) Folder template per entity**

When a new **client entity** is created, auto-create the system folders you listed, including the special modules:

Top-level example (system template):

* Current Year (2025)

* Work Folder

* Bank Accounts

* Credit Card Accounts

* Reports

* Past Years

* Assets

* Corporate Docs

* Payroll

* Share Folder

  * From Client

  * To Client

* Admin (admin\_only)

* Super Admin (super\_admin\_only)

Tax module behavior is special (see next section).

---

**7\) The “Taxes” module vs “Tax Returns” client folder**

Your workflows specify that all client-downloadable tax documents live in **Tax Returns**. 

Workflow 2 — Engagement Letter

Workflow 7 — Client-Facing UX, …

That means you should treat:

* **Tax Returns (client-visible)** \= the client’s downloadable deliverables (engagement PDF, extension acceptance, filed return, notices)

* **Taxes (staff-gated module)** \= internal tax working area / restricted workspace (if you still want it as separate)

This prevents your staff tax access logic from accidentally hiding the client’s own downloadable documents.

---

**8\) Workflows 1–8 as the operating system**

**Workflow 1 — Tax Season Start (invite \+ container creation)**

* Admin selects eligible **entities**

* System creates/ensures entity\_tax\_year and queues invites

* n8n sends email in controlled waves with full logging

* App landing shows only: “Sign Engagement Letter” 

Workflow 1 — Tax Season Start

**Workflow 2 — Engagement Letter**

* First signature unlocks: checklist, questionnaire, uploads, messaging

* MFJ requires 2 signatures for “fully signed”

* PDF generated only when all required signatures are complete

* Stored client-visible in Tax Returns 

Workflow 2 — Engagement Letter

**Workflow 3 — Checklist creation**

* Triggered at first engagement signature

* Firm uploads proforma internally; n8n parses into checklist items

* Fallback: minimal checklist if parsing fails

* Checklist \+ questionnaire run in parallel 

Workflow 3 — Document Checklist…

**Workflow 4 — Uploads \+ notifications \+ “All Docs Received” \+ confirmation**

* Upload from checklist item (ideal) or general upload (fallback)

* Checklist completion \= all required items Received or N/A

* Upload notifications to super\_admin/admin/Idir only (Year 1\)

* When checklist hits 100% → request document receipt confirmation signature 

Workflow 5 — Reminders, Extensi…

⚠️ Note: Your “after confirmation uploads” rule differs between versions; your newest Workflow 7 locks “no reconfirmation,” while this version of Workflow 4 says “invalidate \+ re-sign.” You should keep only one rule systemwide. 

Workflow 5 — Reminders, Extensi…

Workflow 7 — Client-Facing UX, …

**Workflow 5 — Reminders \+ extensions**

* Separate reminder streams: documents, questionnaire, ID

* Deterministic schedule with next\_reminder tracking

* Extension request stops all reminders; resumes relative to extended due date after filing 

Workflow 5 — Reminders, Extensi…

**Workflow 6 — Internal dashboard \+ statuses \+ gate**

Internal primary statuses:

1. Invited

2. Engaged

3. Collecting Docs

4. Awaiting Confirmation

5. Ready for Prep

6. In Prep

7. Awaiting E-file Authorization

8. Filed 

Workflow 6 — Internal Dashboard…

“Ready for Prep” locked gate requires ALL:

* engagement fully signed

* checklist complete

* document confirmation signed

* questionnaire submitted

* ID valid 

Workflow 6 — Internal Dashboard…

**Workflow 7 — Client-facing UX**

Client-visible statuses only:

1. Sign engagement

2. Upload docs / complete questionnaire

3. Confirm documents received

4. We’re reviewing / prep in progress

5. Sign e-file authorization

6. Filed 

Workflow 7 — Client-Facing UX, …

Extension is a banner, not a status. 

Workflow 7 — Client-Facing UX, …

**Workflow 8 — In-app messaging**

* One thread per client \+ tax year

* Created when engagement first signed

* Participants: client(s) \+ super\_admin/admin \+ Idir (Year 1\)

* Every message triggers email notification (delivery \+ backup)

* Threads archived read-only by year end 

Workflow 8 — In-App Messaging 

---

**9\) Automations (n8n) — what it does vs what Supabase stores**

**Supabase \= system of record**

* entities, years, statuses, permissions

* checklist items \+ documents metadata

* reminder schedule state

* message threads \+ unread state

* audit logs

**n8n \= execution engine**

* sends tax season emails (queued batches)

* processes reminder sends (based on next\_reminder\_at)

* sends message emails (outbox pattern recommended)

* handles proforma parsing and checklist generation triggers

* handles document-processing pipeline if you add AI classification

---

**10\) Audit \+ compliance logging (non-negotiable)**

Minimum audit tables:

**status\_audit\_log**

* entity\_tax\_year\_id

* old\_status

* new\_status

* changed\_by

* changed\_at

* reason (optional)

**permission\_audit\_log**

* client/taxes grants changes

* restricted ACL changes

**document\_events**

* uploaded/replaced/marked N/A

* confirmation signed

* extension requested/filed

* e-file auth requested/signed

Workflows explicitly require auditable transitions and proofs for “Filed.” 

Workflow 6 — Internal Dashboard…

---

**11\) UI modules (what screens you are building)**

**Client app**

* Entity switcher (account → entities)

* Tax Season Home (status \+ progress \+ CTA)

* Engagement Letter viewer \+ signature capture

* Checklist UI (upload/replace/add/N/A)

* General upload UI (doc type \+ issuer prompt)

* Questionnaire module (sets \+ conditional questions)

* ID module (validity \+ update)

* Document Receipt Confirmation signature

* E-file authorization signature flow

* Tax Returns downloads

* Messaging thread \+ unread badge \+ “Need help?”

**Staff/admin app**

* Entity selection \+ invite queue/waves

* Internal dashboard (filters by internal\_status, blocked reasons, days stuck)

* Status transition controls (with audit)

* Assignment (Idir / preparer)

* Tax access grant management (staff → can\_see\_taxes)

* Restricted client ACL management (super\_admin only)

* Document triage \+ checklist overrides

* Reminder monitoring \+ escalation visibility

---

**12\) Build order (high-level, “don’t create junk” sequence)**

1. **Auth \+ Profiles \+ Staff Profiles**

2. **Accounts \+ Account Users \+ Client Entities**

3. **Permissions tables** (client\_acl, client\_staff\_permissions, client\_staff\_assignments)

4. **entity\_tax\_year** container \+ internal\_status enum

5. **Folder template \+ folders/documents tables \+ storage bucket**

6. **Workflow 1 invite queue \+ email logging**

7. **Workflow 2 engagement signature \+ PDF storage to Tax Returns**

8. **Checklist tables \+ Workflow 3 proforma ingest \+ fallback**

9. **Workflow 4 uploads \+ checklist completion \+ confirmation signature**

10. **Workflow 5 reminder engine \+ extension flags \+ deterministic scheduling**

11. **Workflow 6 internal dashboard \+ audit trail**

12. **Workflow 8 messaging tables \+ RLS \+ email outbox**

13. Client-facing UX polish (Workflow 7\) \+ internal admin tooling

---

**One important fix to decide (before implementation)**

Your documents show **two competing rules** for post-confirmation uploads:

* “No new confirmation required” (Workflow 7\) 

Workflow 7 — Client-Facing UX, …

* “Confirmation invalidated; re-sign required” (Workflow 4 draft) 

Workflow 5 — Reminders, Extensi…

Pick one and delete the other rule everywhere—otherwise your app will behave inconsistently.

---

If you want, I can also output this same blueprint as:

* a **schema-first checklist** (tables \+ enums \+ key fields),  
  or

* an **RLS policy map** (who can read/write what table).

