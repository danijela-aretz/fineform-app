**Build Plan — Cursor Phases (Backend → Admin → Client)**

**Status: FINAL · CLEAN · IMPLEMENTATION-READY**

This document defines the recommended build phases in Cursor for a dual-frontend system:

• Supabase (single backend \+ storage \+ RLS)  
• n8n (automation engine)  
• Next.js (Admin/Staff desktop app)  
• Flutter (Client mobile app)

Primary goal: ship a stable tax-season system first, while preserving a clean path to bookkeeping workflows later.

---

**Phase 0 — Foundation (Decisions \+ Repo Setup)**

Purpose: establish the minimum decisions and project structure so implementation is consistent.

Deliverables:

• Confirm dual app approach:  
– Next.js \= Admin/Staff  
– Flutter \= Client

• Confirm environments:  
– local dev  
– staging  
– production

• Repos:  
– admin-app (Next.js)  
– client-app (Flutter)  
– optional shared folder for docs/contracts (not shared code)

• Set version control conventions:  
– branch naming  
– migration naming  
– release tags

Guardrails:

• Do not start UI work until Phase 1 is complete.

---

**Phase 1 — Backend Core (Supabase as System of Record)**

Purpose: build the single source of truth that both apps will rely on.

This phase prevents duplication and drift.

**1.1 Database Schema**

Deliverables:

• Auth mirror:  
– profiles  
– staff\_profiles

• Client model:  
– accounts  
– account\_users  
– client\_entities

• Tax-year container:  
– entity\_tax\_year

• Permissions:  
– client\_acl (restricted clients)  
– client\_staff\_permissions (tax visibility grants)  
– client\_staff\_assignments (dashboard workload)

• Folder \+ document model:  
– folders  
– folder\_acl  
– documents

• Checklist \+ questionnaire:  
– checklist\_items  
– checklist\_item\_files (or document linkage model)  
– questionnaire\_sections  
– questionnaire\_answers

• Confirmations \+ signatures:  
– doc\_receipt\_confirmations  
– efile\_authorizations

• Messaging:  
– message\_threads  
– thread\_participants  
– messages

• Reminders \+ scheduling state:  
– reminder\_state (per stream) or equivalent

• Audit logs:  
– status\_audit\_log  
– permission\_audit\_log  
– document\_events

**1.2 RLS Policies (Non-Negotiable)**

Deliverables:

• Client access rules:  
– clients can only see their own account/entities

• Restricted clients:  
– only super\_admin \+ ACL can view

• Tax access:  
– staff can see tax-related items only if granted (or admin default)

• Document and folder security:  
– staff-only folders not visible to clients  
– restricted folders require folder ACL

• Messaging security:  
– clients see only their entity threads  
– staff see only allowed threads

**1.3 Storage**

Deliverables:

• Buckets:  
– client-files

• Path convention:  
– client-files/{client\_id}/{folder\_id}/{filename}

• Access rules:  
– clients only to their permitted files  
– staff per permission rules

**1.4 Canonical Gates (Backend-Owned)**

Deliverables:

• Deterministic checklist completion computation

• ready\_for\_prep maintained in the database:  
– engagement fully signed  
– checklist complete  
– confirmation signed  
– questionnaire complete  
– ID valid

• Triggers/functions to update derived fields

**1.5 Workflow State Enums**

Deliverables:

• Internal status enum (Workflow 6\)

• Client status mapping logic (Workflow 7\)

**1.6 n8n Integration Contracts**

Deliverables:

• Webhook endpoints or outbox tables for:  
– invite sends  
– reminder sends  
– proforma parse \+ checklist generation  
– message email notifications

Success Criteria:

• Both apps can safely read/write without policy exceptions  
• No logic exists only in a UI  
• All gates and security live in the backend

---

**Phase 2 — Admin/Staff App (Next.js Desktop First)**

Purpose: deliver the complete operational system for staff so tax season can run.

**2.1 Authentication \+ Roles**

Deliverables:

• Staff login  
• Role-based routing (super\_admin/admin/staff)  
• Restricted client handling

**2.2 Workflow 1 — Invite Queue**

Deliverables:

• Entity selection view  
• Invite queue (queued/sent/failed)  
• Trigger send wave (n8n)  
• Delivery logs

**2.3 Workflow 3 Controls (Internal)**

Deliverables:

• Proforma upload area  
• Trigger checklist creation (n8n)  
• View checklist result

**2.4 Workflow 6 — Internal Dashboard**

Deliverables:

• Dashboard list by tax year  
• Filters (status, assigned staff, extension state)  
• Entity detail view

• Status transition control (with warnings and audit logging)

• Blocking indicators:  
– engagement state  
– checklist completion  
– confirmation  
– questionnaire  
– ID

**2.5 Permissions \+ Assignments**

Deliverables:

• Restricted client ACL management  
• Tax access grants  
• Staff assignment management

**2.6 Document Review Operations**

Deliverables:

• View uploaded documents by checklist item  
• View version history  
• Download/export

**2.7 Extensions \+ Filing Ops**

Deliverables:

• Mark extension filed  
• Upload acceptance PDF to Tax Returns  
• Confirm due date updates

**2.8 Messaging (Firm Side)**

Deliverables:

• Thread list by entity \+ tax year  
• Reply in app  
• Unread indicators

Success Criteria:

• Staff can run tax season end-to-end using desktop  
• Admin can control invites, visibility, and permissions  
• Internal truth matches Workflow 6

---

**Phase 3 — Client App (Flutter Mobile First)**

Purpose: deliver the smoothest possible document collection and signature flow for clients.

**3.1 Authentication \+ Entity Selection**

Deliverables:

• Client login  
• Entity switcher  
• Tax year home screen

**3.2 Workflow 2 — Engagement Signing**

Deliverables:

• View engagement letter  
• Sign (single / MFJ)  
• Show progress when MFJ partially signed

**3.3 Workflow 4 — Upload Experience (Priority)**

Deliverables:

• Checklist view with per-item upload  
• General upload fallback with type selection  
• Multi-file per item  
• Explicit replace flow

Mobile reliability requirements:

• Upload queue  
• Per-file progress  
• Retry for failures  
• Graceful handling of spotty connectivity

**3.4 Questionnaire**

Deliverables:

• Section progress  
• Save as draft  
• Submit completion

**3.5 Document Receipt Confirmation**

Deliverables:

• Prompt appears at checklist completion  
• One signature per tax year

**3.6 E-File Authorization**

Deliverables:

• Prompt appears when draft return uploaded  
• Capture signature

**3.7 Client Downloads**

Deliverables:

• Tax Returns folder access  
• Download engagement letter, extension, filed return

**3.8 Messaging (Client Side)**

Deliverables:

• One thread per entity \+ year  
• Send messages  
• Unread indicators

Success Criteria:

• Clients can complete the full collection process smoothly on mobile  
• Upload reliability is dramatically improved vs current pain point  
• Client UX matches Workflow 7 statuses

---

**Phase 4 — Hardening \+ Launch**

Purpose: make the system safe, stable, and supportable before real clients.

Deliverables:

• End-to-end scenario walkthroughs (all workflows)  
• Permission \+ RLS penetration testing  
• Reminder send testing (no duplicates)  
• Upload stress tests (large files, weak connection)  
• Audit log validation

• Staging pilot with a small group of real clients

Success Criteria:

• No data leaks  
• No reminder duplication  
• No broken status transitions  
• Upload success rate acceptable  
• Staff can operate without workarounds

---

**Phase 5 — Bookkeeping Module (Future)**

Purpose: replace Google Sheets workflow tracking with structured internal bookkeeping workflows.

Deliverables:

• Monthly period container (client\_entity\_id \+ month)  
• Task templates per client  
• Monthly checklist generation  
• Completion tracking (who/when)  
• Internal notes per month and per client  
• Secure credentials storage (encrypted, staff-restricted)

Success Criteria:

• Staff no longer needs Google Sheets for operational tracking  
• Bookkeeping workflows are auditable and permission-safe

---

**Final Statement**

Build in this order:

• Backend core first  
• Admin/Staff desktop second  
• Client mobile third

This order:

• Prevents duplicated logic  
• Reduces permission bugs  
• Keeps desktop operations strong for tax and bookkeeping  
• Still delivers a high-quality mobile intake experience

